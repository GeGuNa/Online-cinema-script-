define("form_tools","init",function(){var m,p,c,e,d=2e3,l=6,h=3,w="operamobile"==Device.browser&&Device.v<=12;"operamini"!=Device.browser&&"mobile"!=Device.type&&(m=!1,c=0,e={init:function(){var c,u,e,a,n,o,f,s;m=!1,c=this,e=$("body"),$(window),e.on("click","select",function(e){var t=$(this);Spaces.view.setInputError(t,!1)}).on("focus","textarea, input:text, input:password",function(e){var t=$(this);m=!0,w&&t.hasClass("js-resize_ta")&&t.attr("rows",t.data("maxRows")||l),t.data("saveError")||Spaces.view.setInputError(t,!1),c.saveTextareaText(t),p=Date.now()}).on("blur","textarea, input:text",function(e){var t=$(this);m=!1,w&&t.attr("rows",t.data("minRows")||h),c.saveTextareaText(t),u&&clearTimeout(u)}).on("click",".js-temp_text",function(e){e.preventDefault();var t=$(this),a=t.parents().find("textarea:first"),n="saved_text:"+(a.data("text_id")+":"+SPACES_PARAMS.nid)+":tmp";"delete"!=t.data("action")&&a.val(Spaces.LocalStorage.get(n)),Spaces.LocalStorage.remove(n),c.saveTextareaText(a),t.parents(".js-temp_text_parent").remove()}).on("submit","form",function(e){var t,a=$(this),n=Spaces.view.getFormSubmitter(a),o=c.checkForm(a);return!1!==o&&n&&"cfms"==n.attr("name")&&(t=a.find("textarea"),page_loader.one("shutdown",function(){setTimeout(function(){t.each(function(){c.saveTextareaText($(this),!0)})},1e3)})),o}),a=function(e,t){e.parent().find("input:password, input:text").prop("type",t?"text":"password"),e.data("showPasword",t).prop("title",t?L("Спрятать пароль"):L("Показать пароль")).toggleClass("disabled",!t)},"desktop"==Device.type?e.on("mousedown",".js-input_show_password",function(e){var t=$(this);a(t,!0),$("body").on("mouseup.oneRequest",function(){a(t,!1)})}):e.on("click",".js-input_show_password",function(e){e.preventDefault();var t=$(this);a(t,!t.data("showPasword"))}),define("form_tools","onRequest",function(){m=!1}),w||(define("form_tools","onRequest",function(){e.find("form.js-no_enter_submit").on("keypress","input:text",function(e){e.keyCode!=Spaces.KEYS.ENTER&&e.keyCode!=Spaces.KEYS.MAC_ENTER||e.preventDefault()})}),o=function(e){var t=$(e),a=!1;t.data("twice")?((t=t.parents(".js-input_error_wrap:first").find("input:password"))[0].value.length&&t[1].value.length&&t[0].value!=t[1].value&&(a=L("Пароли не совпадают.")),v=t[0].value):v=t.val(),v.match(/[ а-я]/i)?a=L("В пароле допускаются только латинские буквы и цифры."):v.length>t.data("maxlength")&&(a=L("Пароль слишком длинный. Максимальная длина пароля - {0}.",numeral(t.data("maxlength"),[L("$n символ"),L("$n символа"),L("$n символов")]))),Spaces.view.setInputError(t.data("saveError",!!a),a),n=!1},e.on("input keypress paste change blur","input:password",function(e){var t=this;n||(n=setTimeout(function(){o(t)},50))}),e.on("input keypress paste change","textarea, input:text",function(e){var t,a,n,o,s,r=this,i=$(r);i.hasClass("js-resize_ta")&&(r.style,t=parseInt(i.css("line-height")),a=parseInt(i.css("paddingTop"))+parseInt(i.css("paddingBottom")),t||(t=i.data("line_height"))||(t=i.fontMetrics().h,i.data("line_height",t)),n=i.data("maxRows")||l,o=i.data("minRows")||h,r.rows,r.rows=o,s=Math.ceil(r.scrollHeight-a)/t,r.rows=Math.max(Math.min(s,n),o),i.parent().toggleClass("js-ta_scrolled",n<s)),(Date.now()-p>d||!m)&&(c.saveTextareaText(i,!1,!0),m&&(u&&clearTimeout(u),u=setTimeout(function(){u=!1,c.saveTextareaText(i)},d+100)),p=Date.now())})),"desktop"==Device.type&&(s=function(e,t){var a,n,o,s,r,i,c,u,p,d=e.which||e.keyCode||e.charCode,l=m||"INPUT"==e.target.tagName||"TEXTAREA"==e.target.tagName,v=document.activeElement;!v||"INPUT"!=v.tagName&&"TEXTAREA"!=v.tagName||(l=!0),l||!(40<d)||e.ctrlKey||e.metaKey||165<d&&d<184||112<=d&&d<=123||(a=$(".js-autofocus")).length&&(n=$(window).scrollTop(),o=$(window).innerWidth(),s=a.offset().top,r=a.outerHeight(),(n<=s&&s<=n+o||n<=s+r&&s+r<=n+o)&&(a.focus(),Spaces.DdMenu&&(i=Spaces.DdMenu.current())&&!$.contains(i,a)&&Spaces.DdMenu.close(i.attr("id")),!0===t&&(c=a[0],u=String.fromCharCode(d),c.selectionStart!==undefined?(p=c.selectionStart,c.value=c.value.substr(0,p)+u+c.value.substr(p+(c.selectionEnd-p)),set_caret_pos(c,p+1,p+1)):c.value+=u))),f=d},$(document).on("opera"==Device.browser&&Device.v<=12?"keypress":"keydown",s),"firefox"==Device.browser&&$(document).on("keypress",function(e){var t=e.which||e.keyCode||e.charCode;!f&&t&&s(e,!0)}))},saveTextareaText:function(e,t,a){var n,o,s,r=e.data("text_id");if((t||!(Date.now()-c<500))&&(t||!e.data("disabled")&&!e.data("readonly"))&&(e.trigger("text_save",{typing:!!a}),r&&!w)){r+=":"+SPACES_PARAMS.nid;try{n=JSON.parse(Spaces.LocalStorage.get("saved_texts"))}catch(i){n={}}if(!(r in n||t))for(o=[],$.each(n,function(e,t){o.push([e,t])}),o.sort(function(e,t){return t[1]-e[1]}),s=4;s<o.length;++s)Spaces.LocalStorage.remove("saved_text:"+o[s][0]),Spaces.LocalStorage.remove("saved_text:"+o[s][0]+":tmp"),delete n[o[s][0]];!t&&e[0].value.length?(n[r]=Date.now(),Spaces.LocalStorage.set("saved_text:"+r,e[0].value)):(Spaces.LocalStorage.remove("saved_text:"+r),Spaces.LocalStorage.remove("saved_text:"+r+":tmp"),delete n[r]),Spaces.LocalStorage.set("saved_texts",JSON.stringify(n))}},checkForm:function(e){var o=0,t=$(e.prop("submit_btn")||[]);if("cfms"==t.prop("name")||t.data("main_submit"))return e.find(".text-input").each(function(){var e,t=$(this),a=t.attr("maxlength")||t.data("maxlength"),n=t.attr("required")||t.data("required");t.data("validate")&&(a?a<(e=html_wrap(t[0].value).length)&&(Spaces.view.setInputError(t,L("Длина текста не должна превышать {0} (сейчас {1})",numeral(a,[L("$n символ"),L("$n символа"),L("$n символов")]),numeral(e,[L("$n символ"),L("$n символа"),L("$n символов")]))),++o):n&&!$.trim(t[0].value).length?(Spaces.view.setInputError(t,L("Поле должно быть заполнено.")),++o):Spaces.view.setInputError(t,!1))}),!o}},$(function(){e.init()}))});