define("polls","init",function(){var e=function(){function p(e){if(_.val(e),page_loader.ok()){var n=new Url(location.href);n.query.poll_id=e,HistoryManager.replaceState(HistoryManager.state,document.title,n.url())}}function c(){var e,n=!!+_.val(),l=n&&!!+u.find('input[name="object_id"]').val();u.find(".js-poll_del").toggleClass("hide",!n),u.find(".js-poll_btn_wrap").toggleClass("hide",t||!n),u.find(".js-poll_state_new").toggleClass("hide",l),u.find(".js-poll_state_in_process").toggleClass("hide",!l),$("#create_poll_btn").toggleClass("hide",n),e=u.find(".js-poll_var").length,u.find(".js-poll_row_add").toggleClass("hide",e>=f.max),u.find(".js-poll_row_del").toggleClass("hide",e<=f.min)}var u,f,_,t,l=!1;return{init:function(){u=$("#polls_form"),f=u.data(),t=!1,_=u.find('[name="poll_id"]'),u.on("keypress","input",function(e){e.keyCode!=Spaces.KEYS.ENTER&&e.keyCode!=Spaces.KEYS.MAC_ENTER||(e.stopPropagation(),e.preventDefault())}).on("click",".js-poll_btn_wrap",function(e){e.preventDefault();var n=this;"firefox"==Device.browser&&(l||(l=!0,tick(function(){$(n).find(".js-dd_menu_link").click(),l=!1})))}).on("dd_menu_opened","#polls_form_dd",function(){t=!0,c()}).on("dd_menu_closed","#polls_form_dd",function(){t=!1,c()}).on("click",".js-poll_row_add",function(e){e.preventDefault();var n=u.find(".js-poll_var"),l=n.last(),t=l.clone(),o=t.find("input");l.parent().append(t),o.val("").attr("placeholder",L("Вариант ответа #{0}",n.length+1)),Spaces.view.setInputError(o,!1),c()}).on("click",".js-poll_row_del",function(e){e.preventDefault(),u.find(".js-poll_var").last().remove(),c()}).on("click",".js-poll_del",function(e){u.data("widget")&&(e.preventDefault(),$(this),Spaces.api("neoapi/polls.delete",{CK:null,Pid:_.val()}),p(0),c(),Spaces.DdMenu.close())}).on("click",".js-poll_save",function(e){var n,l,t,o,i,a,s,r,d;if(u.data("widget")&&e.preventDefault(),!u.data("busy")){if(n=0,l=$(this),t=u.find('[name="description"]'),o=u.find(".js-poll_var input"),Spaces.view.setInputError(t,!1),Spaces.view.setInputError(o,!1),$.trim(t.val()).length||(Spaces.view.setInputError(t,L("Вы не ввели тему опроса.")),++n),i=0,a=[],o.each(function(){$.trim($(this).val()).length?++i:a.push(this)}),i<f.min&&(s=$(a.slice(0,f.min-i)),Spaces.view.setInputError(s,L("Необходимо заполнить не менее {0}.",numeral(f.min,[L("$n варианта"),L("$n вариантов"),L("$n вариантов")]))),++n),!n){if(!u.data("widget"))return;u.data("busy",!0),l.find(".ico").addClass("ico_spinner"),r=function(){u.data("busy",!1),l.find(".ico").removeClass("ico_spinner")},d=Url.serializeForm(u),+_.val()&&(d.edit=1),d.object_id=d.object_id||0,Spaces.api("neoapi/polls.create",d,function(e){if(r(),0!=e.code){var n=t;e.code==Codes.POLLS.ERR_WRONG_VARIANT&&(n=$(o[e.number])),Spaces.view.setInputError(n,Spaces.apiError(e))}else u.find(".js-poll_subject").text(t.val()),p(e.pollId),c(),Spaces.DdMenu.close()},{onError:function(e){r(),Spaces.view.setInputError(t,e)}})}e.preventDefault()}})},destroy:function(){u=f=_=null}}}();define("polls","onRequest",function(){$(e.init),page_loader.onShutdown("polls",function(){e.destroy()})})});