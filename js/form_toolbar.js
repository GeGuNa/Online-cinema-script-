define("form_toolbar","init",function(){function n(c,o){function l(){var t,e,i,a,o,l,n=Math.max(4,Math.floor(E.innerWidth()/40));if(B!=n){for(t=E.find("table:first"),g.detach(),e=t.find("tr"),a=(i=t.find("td").detach()).length/n,o=0;o<i.length;++o)l=i[o],$(e[Math.floor((1<a?o+1:o)/n)]).append(l);e.toggleClass("hide",!F),$(e[0]).removeClass("hide").append(g.toggleClass("hide",a<=1)),g.find(".js-bb_more").toggleClass("js-clicked",F),B=n}}function t(){if(i){var t=c[0].value.length;i[0].innerHTML=t,i[0].style.color=T<t?"red":""}}function r(t){var e,i,a=!1;"pic"==t&&n()&&E.find(".js-bb_pic").hasClass("js-clicked")?r():(k&&(e=k,"color"!=(i=t)&&"fon"!=i||e.find(".js-bb_colorpicker").colorpicker(!1),a=k.data("tag")==t,k.remove(),m.hide(),j.removeClass("js-clicked"),j=k=null,Spaces.fixHeight(),$("body").off("click.sp_toolbar")),t&&!a&&(j=E.find(".js-bb_"+t).addClass("js-clicked"),k=$(Y(function(t){{if("color"==t||"fon"==t)return R(t);if("code"==t)return V();if("pic"==t)return X({files:"operamini"!=Device.browser&&o.activeAttaches,vote:!1});if(P[t].param)return J({tag:t,value:P[t].shortTag?(e=h||b(c),e?c[0].value.substr(e[0],e[1]):""):"",placeholder:P[t].param})}var e}(t))).data("tag",t),m.append(k).show(),("operamini"==Device.browser||Device.webkit()&&Device.webkit()<=533.1)&&"absolute"==k.css("position")&&k.css("position","static"),"operamini"!=Device.browser&&tick(function(){$("body").on("click.sp_toolbar",function(t){$(t.target).parents(".js-bb_menu").length||r()})}),Loader.loaded("dd_menu")&&Spaces.DdMenu.close(),Spaces.fixHeight(k),function(e,i){if("color"==i||"fon"==i){var t=e.find(".js-bb_colorpicker"),a=t.colorpicker();t.on("colorpicker:select",function(t,e){f("["+i+"="+e.color+"]","[/"+i+"]",""),r()}),e.on("click",".js-bb_color",function(t){t.preventDefault(),a.setColor($(this).data("val"))}).on("click",".js-bb_own_color",function(t){t.preventDefault(),$(this).toggleClass("clicked"),e.find(".js-bb_colorpicker_tab").toggleClass("hide")})}}(k,t)),d())}function n(){var t=k&&k.data("tag");return y||/spoiler|user|comm|pic/.test(t)}function d(){E.find(".js-bb_pic").toggleClass("js-clicked",n())}function s(t){var e=$("body");r(),SmilesMenu.toggle(x,E[0],function(t){v(function(){return t+" "})},function(){t.find(".ico_smile").addClass("ico_smile_blue"),e.off("click.sp_toolbar"),tick(function(){e.on("click.sp_toolbar",function(t){!$(t.target).parents(".smiles_menu").length&&$(t.target).parents("body").length&&SmilesMenu.toggle(x,E[0],!1)})})},function(){e.off("click.sp_toolbar"),t.find(".ico_smile").removeClass("ico_smile_blue")})}function p(t){var e,i,a,o,l,n,s=E.find(".js-bb_hid_attach").data("temp_type",t);tick(function(){r(),s.click()}),y=!0,s.hasClass("js-attach")||(e=s.parents("form"),i=$('<div id="azzzkoe_kostilishe_'+Date.now()+'"></div>'),a=e.find(".js-attach"),o=e.find(".js-attaches").data("max_files"),l=[],i.on("onNewAttach",function(t,e){t.stopPropagation(),t.stopImmediatePropagation(),l.length||tick(function(){_(l),l=[]}),l.push(e.file)}).on("AttachSelectorClose",function(){y=!1,d()}),e.on("onNewAttachBb",function(t,e){_([e.file])}),e.after(i),n=[],a.each(function(){n=n.concat($(this).data("fileTypes"))}),s.addClass("js-attach").data({form:"#"+i.attr("id"),max_files:o,fileTypes:n,exVideo:a.data("exVideo"),comm:a.data("comm"),"public":a.data("public"),attaches:!1,linkDownload:!0,upload:!0,spoiler:"#ddspoiler_"+x,proxyUpload:1<o,fix_position:-10,no_label:!0}),tick(function(){AttachSelector.instance(i).setParent(AttachSelector.instance(e))}))}function u(t){return t.type==Spaces.TYPES.EXTERNAL_VIDEO?{tag:q[t.source_type],val:t.video_id}:{tag:M[t.type],val:t.nid}}function _(n){v(function(){var t,e,i,a=AttachSelector.instance(c),o="",l=!1;for(t=0;t<n.length;++t)i=u(e=n[t]),a.onAttachSelect(e,!0)&&(l=!0),o+="["+i.tag+"="+i.val+"]";return l&&a.saveAttaches(n),o})}function a(t){var e,i,a=P[t];c.attr("disabled")||c.attr("readonly")||("smile"==t?s(E.find(".js-bb_smile")):"pic2"==t?p():"more"==t?(B=0,F=!F,l()):"quote"==t?f("[quote]","[/quote]",w||""):"url"==t?v(function(t){if(t.length)return"[url="+t+"]"+L("ссылка")+"[/url]";var e=$("#toolbar_payload").data("clipboard")||"";return e?html_unwrap(e):"[url="+location.protocol+"//"+base_domain()+"]"+L("ссылка")+"[/url]"}):a.dd?r(t):a.nobb||(e={color:"green",fon:"LightBlue",gray:"#ccc"}[t],f("["+(i=a.bbTag||t)+(e?"="+e:"")+"]","[/"+i+"]","")))}function e(){$("body, html").off(".sp_toolbar"),$(window).off(".sp_toolbar"),C&&clearInterval(C)}function b(t){var e,i,a,o=0,l=0;if(c[0].selectionStart!==undefined)o=c[0].selectionStart,l=c[0].selectionEnd-c[0].selectionStart;else{if(!document.selection||!c[0].createTextRange)return null;if(t)return null;c[0].focus(),e=c[0].value.length,l=(i=document.selection.createRange()).text.length,(a=c[0].createTextRange()).moveToBookmark(i.getBookmark()),o=-a.moveStart("character",-e)}return[o,l]}function f(a,o,l,n){var s;v(function(t,e){var i=n||t||l;return e&&(s=e[0]+a.length+i.length),a+i+o}),s&&set_caret_pos(c[0],s,s)}function v(t){var e,i,a=h||b(c),o=[c.scrollLeft(),c.scrollTop()];a?(e=t(c[0].value.substr(a[0],a[1]),a),i=a[0]+e.length,c[0].value=c[0].value.substr(0,a[0])+e+c[0].value.substr(a[0]+a[1]),c[0].focus()):(c[0].value+=t(""),i=c[0].value.length),h=null,c[0].focus(),set_caret_pos(c[0],i,i),c.scrollLeft(o[0]).scrollTop(o[1]).trigger("change")}var h,m,i,g,k,j,w,C,y,S,x=c.attr("id")||"tb_"+Date.now(),D=c.parents(".js-toolbar_wrap"),E=D.find(".js-toolbar"),A=D.find(".js-toolbar_inline"),T=c.data("maxlength")||c.attr("maxlength")||0,F=!1,B=0;o=extend({length:!0,inline:!1,toolbar:!0,hide:!1,activeAttaches:!1,inline:!1,disable:{},hideCounter:!1},o),E.length||(E=$('<div class="cf">'),o.toolbar?c.before(E):c.after(E)),("operamini"==Device.browser||o.inline)&&(o.length=!1),S=!c.parents(".text-input__wrap").length&&!o.toolbar,o.toolbar&&E.append(O({hide:o.hide,old:S,disabled:{fon:o.disable.bgcolor}})),o.length&&T&&(i=$(H({id:x,old:S,maxlength:T,hide:o.hideCounter})),S?E.append(i):c.after(i),i=i.find(".js-bb_counter")),o.inline&&A.html(z({allowed:I[o.inline]})).find("a").click(function(t){t.preventDefault(),a($(this).data("tag"))}),E.append(N(x)),m=E.find(".js-bb_menu"),E.find(".js-bb_smile_menu"),g=E.find(".js-bb_more").parent("td"),c.parents("form").find(".js-smile").show().click(function(t){t.preventDefault(),s($(this))}),"operamini"!=Device.browser&&c.parents("form").find(".js-bb_toggle").show().click(function(t){t.preventDefault();var e=E.find("table");e.toggleClass("hide"),$(this).toggleClass("js-clicked")}),E.find("a").click(function(t){t.preventDefault(),a($(this).data("tag"))}),m.on("click",".js-bb_insert_tag",function(t){var e,i,a,o;t.preventDefault(),e=$(this),i=e.data("tag"),a=e.data("val")||E.find(".js-bb_value_input").val(),(o=P[i]).shortTag?v(function(){return o.shortTag.replace("__value__",a||o.def)}):f("["+i+"="+a+"]","[/"+i+"]",""),r()}),m.on("click",".js-bb_attach",function(t){var e,i;t.preventDefault(),e=$(this).data("type"),(i={file:Spaces.TYPES.FILE,picture:Spaces.TYPES.PICTURE,music:Spaces.TYPES.MUSIC,video:Spaces.TYPES.VIDEO})[e]?p(i[e]):"close"==e?r():"vote"==e?alert("Ничего нет!"):r(e)}),t(),l(),"operamini"!=Device.browser&&(c.on("focus",function(){T&&(C=setInterval(t,300)),h=null}).on("blur",function(){T&&clearInterval(C),h=b(!(C=null)),t()}).on("change",function(){C||t()}),$(window).on("resize.sp_toolbar orientationchange.sp_toolbar",function(){l()}),$(document.documentElement).on("mouseup.sp_toolbar",function(){var t;window.getSelection?t=window.getSelection():document.getSelection?t=document.getSelection():document.selection&&(t=document.selection.createRange().text),t&&(w=$.trim(t))}),o.activeAttaches&&(c.on("onDropAttach",function(t,e){_([e])}),E.parents("form").on("onDeleteAttach",function(t,e){var i,a,o;i=e.file,a=u(i),o=RegExp("\\["+a.tag+"="+a.val+"\\]","gi"),c.val(c.val().replace(o,""))})),c.keydown(function(i){i.altKey&&$.each(P,function(t,e){e.key==i.keyCode&&a(t)})}),require("text_restore",function(){tick(function(){c.hasClass("js-has_saved_text")&&(c.removeClass("js-has_saved_text"),E.prepend(U()))})})),page_loader.push("shutdown",e)}var s,I={chat:{quote:!0}},P={quote:{iconInline:"ico ico_quote",icon:"ico_mail ico_mail_quote",title:L("Цитата"),key:81},url:{icon:"ico_mail ico_mail_link",title:L("Ссылка")},pic:{icon:"ico ico_plus_grey",dd:!0,title:L("Вставить")},color:{icon:"ico_mail ico_mail_color",title:L("Цвет шрифта"),dd:!0},b:{icon:"ico_mail ico_mail_bold",title:L("Жирный шрифт"),key:66},i:{icon:"bb/grey/italics.png",icon:"ico_mail ico_mail_italic",title:L("Наклонный шрифт"),key:73},u:{icon:"ico_mail ico_mail_underline",title:L("Подчеркнутый шрифт"),key:85},s:{icon:"ico_mail ico_mail_strike",title:L("Зачеркнутый шрифт"),key:83},smile:{icon:"ico ico_smile",title:L("Смайлы")},code:{icon:"ico_mail ico_mail_code",title:L("Код"),dd:!0},spoiler:{hide:!0,key:72,param:L("Введите название спойлера")},gray:{hide:!0,bbTag:"color",key:71},fon:{icon:"ico_mail ico_mail_background",title:L("Цвет фона"),dd:!0},more:{icon:"ico ico_more",title:L("Ещё")},user:{hide:!0,shortTag:"@__value__ ",param:L("Введите ник пользователя"),def:Spaces.params.name},comm:{hide:!0,shortTag:"$__value__$ ",def:"support",param:L("Введите имя сообщества")}},M=mkhash([[Spaces.TYPES.FILE,"file"],[Spaces.TYPES.MUSIC,"music"],[Spaces.TYPES.PICTURE,"pic"],[Spaces.TYPES.VIDEO,"video"]]),q=mkhash([[Spaces.ExternalVideo.YOUTUBE,"youtube"]]),c=["90CAF9 80DEEA A5D6A7 FFF59D FFCC80 FFAB91 CE93D8".split(" "),"2196F3 00BCD4 4CAF50 FFEB3B FF9800 F44336 9C27B0".split(" "),"1565C0 00838F 2E7D32 F9A825 EF6C00 C62828 6A1B9A".split(" "),"ECF0F1 CFD8DC B0BEC5 97A6B0 546E7A 44565E 3A474C".split(" ")],a={text:L("Текст"),ini:"^","1c":"^",json:"^",sql:"^",javascript:"JavaScript",php:"^",cpp:"C/C++",actionscript:"ActionScript",coffeescript:"CoffeScript",http:"^",cmake:"CMake",avrasm:"AVR Asm",vim:"^",vbnet:"VB.NET","vbscript-html":"VBScript (HTML)",cs:"C#",vbscript:"VBScript",css:"^",xml:"^",x86asm:"X86 ASM",applescript:"AppleScript",typescript:"TypeScript",objectivec:"Objective C"},o="text delphi ini 1c json sql javascript perl swift lisp d nginx php java cpp actionscript lua coffeescript vala http go avrasm vim dos vbnet xml vbscript-html bash cs python diff less erlang matlab vbscript css rust apache prolog markdown x86asm applescript fortran makefile ruby smali typescript cmake objectivec".split(" "),R=function(t){var e,i,a,o="desktop"==Device.type,l=o?"js-bb_color":"js-bb_insert_tag",n='<div class="widgets-group dropdown-menu wbg toolbar__spoiler"><div class="t_center"><table class="table__wrap bb-colorpicker"><tr>';for(n+='<td class="table__cell'+(o?"":" table__cell_last js-bb_colorpicker_tab")+'"><div class="'+(o?"stnd-block":"static-bl")+'">',e=0;e<c.length;++e){for(n+="<div>",i=0;i<c[e].length;++i)n+='<div style="background-color:#'+(a=c[e][i])+'" data-tag="'+t+'" data-val="#'+a+'" class="'+l+' toolbar-color pointer"></div>';n+="</div>"}return n+="</div></td>",n+='<td class="table__cell table__cell_last'+(o?"":" hide js-bb_colorpicker_tab")+'"><div class="'+(o?"stnd-block":"static-bl")+'"><div class="js-bb_colorpicker"></div></div></td>',n+="</tr></table></div>",o||(n+='<div class="links-group links-group_grey t_center"><a href="#" class="list-link js-bb_own_color">'+L("Выбрать свой цвет")+"</a></div>"),n+="</div>"},V=function(){var t,e,i='<div class="widgets-group dropdown-menu wbg toolbar__spoiler"><div class="static-bl">';for(t=0;t<o.length;++t)e=o[t],e=a[e]?"^"==a[e]?e.toUpperCase():a[e]:e.substr(0,1).toUpperCase()+e.substr(1),i+='<a href="#code-'+t+'" data-tag="code" data-val="'+o[t]+'" class="js-bb_insert_tag">'+e+"</a>",t!=o.length-1&&(i+=", ");return i+="</div></div>"},Y=function(t){return'<div class="spoiler_inject dropdown-menu" skip="1">'+t+"</div>"},U=function(t){return'<div class="nl service-info system-message_service mb10 js-temp_text_parent">'+L("Обнаружен черновик.")+' <a href="#" class="js-temp_text" data-action="restore">'+L("Восстановить")+'</a><span class="ico ico_remove right pointer js-temp_text" data-action="delete"></span></div>'},O=function(i){var a=Date.now(),o='<div class="toolbar__wrap"><table class="toolbar table__wrap'+(i.hide?" hide":"")+'"><tr>';return $.each(P,function(t,e){i.disabled[t]||e.hide||(o+='<td class="table__cell"><a href="#l'+a+t+'" data-no_label="1" class="list-link js-bb_'+t+'" title="'+e.title+'" data-tag="'+t+'"><span class="'+e.icon+'"></span></a></td>')}),o+='</tr><tr class="hide"></tr><tr class="hide"></tr><tr class="hide"></tr></table></div>'},z=function(i){Date.now();var a="";return $.each(P,function(t,e){i.allowed[t]&&(a+='<button href="#bb-'+t+'" class="url-btn button" data-tag="'+t+'" title="'+e.title+'"><span class="'+e.iconInline+'"></span></button>')}),a},H=function(t){return t.old?'<span class="right counterBlock"><span class="js-bb_counter">0</span>/'+t.maxlength+"</span>":'<span class="right cntBl'+(t.hide?" hide":"")+'"><span class="js-bb_counter">0</span>/'+t.maxlength+"</span>"},N=function(t){return'<div class="hide"><span class="js-bb_hid_attach"></span></div><div class="js-bb_smile_menu smiles_menu hide"></div><div class="hide spoiler_inject" id="ddspoiler_'+t+'"></div><div class="js-bb_menu" style="position:relative;display:none"></div>'},X=function(t){var o,e={picture:[L("Фото"),"ico_mail ico_mail_picture"],music:[L("Музыка"),"ico_mail ico_mail_music"],video:[L("Видео"),"ico_mail ico_mail_video"],file:[L("Файлы"),"ico_mail ico_mail_file",!0]},i={vote:[L("Опрос"),"ico ico_vote"]},a={user:[L("Ссылка на пользователя"),"ico ico_user"],comm:[L("Ссылка на сообщество"),"ico ico_mode_froffr"],spoiler:[L("Спойлер"),"ico_mail ico_mail_spoiler"],close:[L("Отменить"),"ico ico_remove"]},l={};return t.files&&$.extend(l,e),t.vote&&$.extend(l,i),$.extend(l,a),o='<div class="widgets-group links-group links-group_grey dropdown-menu bb0 toolbar__spoiler">',$.each2(l,function(t,e,i){var a=i.first?" list-link_first":i.last?" list-link_last":"";o+='<a href="#bb-'+t+'" class="list-link js-bb_attach'+a+'" data-type="'+t+'"'+(e[2]?' style="border-bottom-width: 2px"':"")+'><span class="'+e[1]+'"></span> '+e[0]+"</a>"}),o+="</div>"},J=function(t){return'<div class="widgets-group dropdown-menu wbg toolbar__spoiler"><div class="static-bl"><div class="text-input__wrap"><input type="text" class="text-input js-bb_value_input" data-no_paste="1" value="'+html_wrap(t.value)+'" placeholder="'+t.placeholder+'"></div></div><table class="table__wrap"><tr><td class="table__cell links-group links-group_grey table__cell_border" width="50%"><a href="#bb-add" class="list-link list-link-blue bb0 js-bb_insert_tag" data-tag="'+t.tag+'"><span class="ico ico_plus"></span><span class="t">'+L("Добавить")+'</span></a></td><td class="table__cell links-group links-group_grey table__cell_last" width="50%"><a href="#bb-close" class="list-link bb0 js-bb_attach" data-type="close"><span class="t">'+L("Отмена")+"</span></a></td></tr></table></div>"};window.Toolbar=n,$.extend(n,{expand:function(t,e){var i=t.findClass("js-bb_toggle");i.length&&e!=i.hasClass("js-clicked")&&i.click()}}),s=!1,define("form_toolbar","onRequire",function(){s||(s=!0,Loader.ready(function(){var t,e,i,a,o,l;for(s=!1,t=$("textarea, input"),e=0;e<t.length;++e)i=t[e],(a=""===(l=i.getAttribute("data-toolbar"))?{}:l?light_json(l):undefined)&&((o=$(i)).data("__toolbar__")||o.data("__toolbar__",new n(o,a)))}))})});