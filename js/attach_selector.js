define("attach_selector","init",function(){"use strict";var d,i,p,r,u,h,n,_,f,l,m,o,c,e,v,s,g,S;"operamini"!=Device.browser&&(d={},i=[Spaces.TYPES.PICTURE,Spaces.TYPES.MUSIC,Spaces.TYPES.VIDEO,Spaces.TYPES.FILE],d[Spaces.TYPES.FILE]={name:L("Файлы"),title:L("Файлы"),title2:L("файлов"),icon:"ico_mail ico_mail_file",type:Spaces.TYPES.FILE,sex:1},d[Spaces.TYPES.VIDEO]={name:L("Видео"),title:L("Видео"),title2:L("видео"),icon:"ico_mail ico_mail_video",type:Spaces.TYPES.VIDEO,sex:0},d[Spaces.TYPES.MUSIC]={name:L("Музыка"),title:L("Музыка"),title2:L("треков"),icon:"ico_mail ico_mail_music",type:Spaces.TYPES.MUSIC,sex:1},d[Spaces.TYPES.PICTURE]={name:L("Фото"),title:L("Фотографии"),title2:L("фотографий"),icon:"ico_mail ico_mail_picture",type:Spaces.TYPES.PICTURE,sex:0},p={0:"comm",1:"user"},/^http(s?):\/\/|#.*?$/gi,r={},u=1e4,n=0,l=f=!(_={typeSelect:function(t){var e,a,s='<div class="links-group links-group_grey">';for(e=0;e<i.length;++e)a=d[i[e]],t.types&&$.inArray(+a.type,t.types)<0||(s+='<a href="#" class="list-link js-select_file" data-type="'+a.type+'"><span class="'+a.icon+'"></span> '+a.name+"</a>");return s+='<a href="#" class="list-link js-dd_menu_close"><span class="ico ico_remove"></span> '+L("Отменить")+"</a></div>"},quickSelector:function(t){return'<div class="links-group links-group_grey hide" data-view="action" data-empty="1"></div>'+(t.upload?'<div class="upload-dnd_msg js-attach_dnd"><div class="js-dnd_msg"></div></div>':"")+'<div class="hide" data-view="upload_progress"><div class="static-bl js-qsel_link_upload"><div class="grey pad_b_a">Загрузка файла...</div>'+_.spinner3()+'</div></div><div class="hide" style="background: #FFF; color: #323232;" data-view="upload"><div class="js-qsel_upload_file"></div><div class="js-qsel_upload_widget_wrap"><div class="js-qsel_upload_widget"></div></div></div><div class="links-group links-group_grey hide" data-view="main"><table class="table__wrap'+(t.sources?"":" hide")+'"><tr><td class="table__cell links-group links-group_grey table__cell_last" width="50%"><a href="#" class="list-link upper_case b js-attach_source" data-source="comm">'+L("Сообщество")+'</a></td><td class="table__cell links-group links-group_grey table_cell_border" width="50%"><a href="#" class="list-link js-attach_source upper_case b" data-source="user">'+L("Мои файлы")+'</a></td></tr></table><div class="js-qsel_main"><div class="b-title b-title_first b-title_in-window'+(t.showSlider?"":" hide")+'">'+d[t.type].title+' <span class="js-qsel_cnt cnt hide">0</span><a href="#" class="link-imp right js-qsel_all"><span class="js-qsel_all_spinner hide ico f__ico_spinner2"></span> '+L("ВСЕ")+' <span class="ico ico_arrow"></span></a></div><div class="js-qsel_carousel'+(t.showSlider?"":" hide")+'"></div><div class="js-qsel_error" style="color: red"></div><div class="links-group links-group_grey"><div class="js-qsel_upload_err stnd-block error__msg content-bl__sep hide"></div>'+(t.upload?'<span class="list-link list-link_first js-qsel_upload_btn disabled"><span class="js-content"><span class="ico ico_upload js-upload_btn_ico hide"></span> <span class="ico f__ico_spinner2 js-upload_btn_spinner"></span> '+(d[t.type].sex?L("Загрузить новый"):L("Загрузить новое"))+"</span></span>":"")+(t.linkDownload?'<div class="static-bl js-qsel_link_upload"><label class="label text">'+L("Загрузить по ссылке:")+'</label><table class="table__wrap table__wrap-layout"><tr><td style="width: 100%" class="table__cell"><div class="text-input__wrap"><input type="text" class="text-input js-qsel_link_input" data-no_paste="1" value="" placeholder="'+L("Введите ссылку")+'" /></div></td><td class="table__cell padd_left"><button disabled="disabled" type="submit" class="btn btn_input js-qsel_download_url_btn" name="qsel_select_btn">'+L("Загрузить")+"</button></td></tr></table></div>":"")+'<div class="qsel-cust_btn"></div>'+(t.attaches?'<table class="table__wrap"><tr class="js-upload_state-uploading" style="display: table-row;"><td class="table__cell links-group links-group_grey table__cell_border" width="50%"><a href="#" class="list-link list-link-blue js-qsel_select_btn disabled"><span class="ico ico_plus"></span> <span class="t">'+t.attachBtnName+'</span></a></td><td class="table__cell links-group links-group_grey table__cell_last" width="50%"><a href="#" class="list-link js-dd_menu_close" id="upload_cancel_btn"><span class="ico ico_remove"></span> <span class="t">'+L("Отменить")+"</span></a></td></tr></table>":'<a href="#" class="list-link list-link_last js-dd_menu_close"><span class="ico ico_remove"></span> '+L("Отменить")+"</a>")+"</div></div></div>"},spinner:function(){return _.message({text:'<span class="ico f__ico_spinner2"></span> '+L("Загрузка...")})},spinner2:function(t){return'<div class="js-tmp_spinner list-link-darkblue stnd_padd content-bl__sep"><span class="ico f__ico_spinner2 m"></span> <span class="m">'+t+"</span></div>"},spinner3:function(){return'<div class="progress-item js-tmp_pg_spinner"><div class="progress-item__runner progress-item__runner_anim"></div></div>'},dndPlace:function(){return'<div class="upload-dnd_msg"><div class="js-dnd_msg"></div></div>'},message:function(t){return'<div class="content-bl content-bl_first content-bl__sep">'+t.text+"</div>"},error:function(t){return _.message({text:'<span style="color: red">'+t.text+"</span>"})+(t.no_button?"":'<button class="menu_back btn-main js-qsel_back" data-back_view="'+(t.back||"main")+'"><span class="ico ico_remove"></span> '+L("Закрыть")+"</button>")},attach:function(t){return t.show_preview?'<div class="tiled_item js-attach_item tiled_item-128 tiled_fixed" id="'+t.nid+"_"+t.type+'"><div class="tiled_inner t_center relative"><div class="tiled-preview"></div></div></div>':'<div class="stnd_padd oh js-attach_item attaches_item" id="'+t.nid+"_"+t.type+'"><div class="stnd-block inh-size transp_bg stnd-block_outer-mrg"><span class="ico f__ico_spinner2"></span></div></div>'},musicList:function(t){var e,a,s='<div class="links-group links-group_grey">';for(e=0;e<t.files.length;++e)s+='<a href="'+(a=t.files[e]).preview.URL+'" class="list-link list-link_select_item js-qsel_select_music" data-nid="'+a.nid+'" data-type="'+a.type+'" data-name="'+a.artist+" - "+a.title+'"><span class="ico ico_photo_select"></span><div class="no_word_break"><span class="ico ico_music"></span> <b>'+a.artist+"</b> - "+a.title+"</div></a>";return s+="</div>"},uploadProgressWrap:function(t){return'<div class="stnd_padd light_border_bottom grey pointer js-qsel_upload_progress_wrap"></div>'},disabledUploadError:function(){return L("Добавление файлов в сообщество запрещено.")+"<br />"+L("Чтобы прикрепить новый файл, воспользуйтесь вкладкой {0} вверху страницы.",'<a href="#" class="js-attach_source" data-source="user">'+L("Мои файлы")+"</a> ")}}),o={},c={},g=!(v=[]),S=Class({Static:{init:function(){var i=this;$("#main").on("click",".js-attach_delete",function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();var e=$(this),a=i.instance(e),s=S.parseId(e.data("id"));a.deleteAttach(s.nid,s.type)}).on("click",".js-attach",function(t){i.setup(this)}).on("click",".js-postpone",function(t){t.preventDefault();var e=$(this),a=e.parents("form"),s=a.find(".js-postpone_state");a.find(".js-postpone_form").toggleClass("hide"),e.find(".js-ico").toggleClass("ico_history ico_history_black"),s.val(+s.val()?0:1)}),i._initDND()},parseId:function(t){var e=t.match(/(\d+)_(\d+)/);return{nid:+e[1],type:+e[2],id:t}},parseFile:function(t){return $.extend(this.parseId(t.attr("id")),t.data())},_initUploader:function(){var a,s,e=this;g||(g=!0,a=function(t){t.state.limit<2&&(t.view("main",!0),t.view("upload").find(".js-qsel_upload_file").empty(),t.view("upload").find(".js-qsel_upload_widget_wrap").show())},s=[],FileUploader.init({buttonClass:{hover:"strong_clicked",active:"strong_clicked_active"},autoSubmit:!0,noDragClass:!0,removeAfterUpload:!0,multiple:!0,onSubmit:function(t){var e,a;l=!0,(e=o[t.id]).state.limit<2&&(e.state.noAutoSelect||e.sliderSelect(),f=!0,e.view("upload",!0)),a={},e.state.dir!==undefined?a.dir=e.state.dir:(a.Att=1,e.state.privateAttaches&&(a.Ss=1)),e.state.commId&&"comm"==m&&(a.Comm=e.state.commId),e.state.talkId&&(a.Talk=e.state.talkId),FileUploader.setPostData(a)},onShowNative:function(){S.active().view("upload",!0)},onFileUpload:function(t,e){l=f=!1;var a=t.data,s=o[e.id];s.onAttachSelect(a,!0,!!c[e.id])&&s.saveAttaches([a]),s.state.limit<2&&s.menu.close()},onError:function(t){l=f=!1;var e=S.active();e&&e.showError(t)},onFileError:function(t,e){var a=S.active();a&&a.state.limit<2&&a.showError(e)},onHideError:function(){},onReset:function(t){l=f=!1,t&&a(e)},onNewFileAdd:function(t){var e,a=S.active();return a.state.proxyUpload?(t.file.file._spaces={type:a.current_type,bb:!0},s.push(t.file.file),!1):!!a.state.upload&&(a.state.uploadError?(a.showError(a.state.uploadError),!1):((e=t.file.file._spaces)&&e.bb&&(c[t.file.id]=!0),void(1<(o[t.file.id]=a).state.limit?(a.onAttachUpload(t.file.id,t.widget),t.file.error&&tick(function(){a.menu.close()})):(a.view("upload").find(".js-qsel_upload_widget_wrap").hide(),a.view("upload").find(".js-qsel_upload_file").empty().append(_.uploadProgressWrap()),a.view("upload").find(".js-qsel_upload_progress_wrap").append(t.widget)))))},onFilesChunkEnd:function(t){var e=S.active();if(e.state.proxyUpload)return e.menu.close(),void tick(function(){e.parent.form.trigger("files",{files:s}),s=[]});e.state.noAutoSelect||e.sliderSelect(),e.checkAttList()},onAfterAutoSubmit:function(){var t=S.active();1<t.state.limit&&t.menu.close()},onRemoveFile:function(t){var e=o[t.id];e.checkAttList(),a(e),tick(function(){e.checkComplete()})},onGetTotal:function(t){var e=S.active();t.total=e.getTotal()}}))},_initDND:function(){var s=function(t,e){t.find(".upload-dnd_msg").toggleClass("upload-dnd_msg_active",e).find(".js-dnd_msg").text(e?L("Отпустите клавишу мыши, чтобы прикрепить файлы."):L("Перенесите сюда файлы, чтобы прикрепить их к сообщению."));$(".upload-dnd_msg .js-dnd_msg").each(function(){var t,e,a=$(this),s=$(window),i=s.scrollTop(),n=s.innerHeight(),l=a.parent(),o=l.offset(),c=l.height();c&&(o.top<i||o.top+c>i+n)?(t=Math.max(i,o.top),e=Math.min(o.top+c,i+n),a.css("top",(e-t)/2+Math.max(0,i-o.top)+"px")):a.css("top","50%")})};pushstream&&pushstream.on("message","media_urls",function(t){if(t.act==Spaces.LongPollingTypes.LOADED_FILE&&h){var e=((Date.now()-h.time)/1e3).toFixed(2);0==t.code&&t.data?(console.log("[getImage] "+h.url+" - OK ("+e+"s)"),h.callback(t)):(console.log("[getImage] "+h.url+" - server error ("+e+"s): "+Spaces.apiError(t)),h.callback(!1,!1,Spaces.apiError(t)))}}),page_loader.on("formsubmit","media_urls",function(t){var e=$(t.form),a=$(t.form.submit_btn),s=AttachSelector.instance(a),i=function(){e.find("textarea").removeAttr("disabled").each(function(){var t=$(this);t.val(s.stripUrls(t.val()))})};if(s)return!e.data("disabled")&&(AttachSelector.isBusy()?(e.data("disabled",!0),e.find("textarea").attr("disabled","disabled"),AttachSelector.onDone(function(){e.removeData("disabled"),i(),a.click()}),!1):void i())},{persistOnRequest:!0}),$("#main").on("dragGlobalStart",function(){var t,e,a=S.active();if(a)a.upload_inited&&((t=a.menu.content()).addClass("upload-dnd_msg_show"),s(t,!1));else for(e=0;e<v.length;++e)(a=v[e])&&((t=a.state.form).addClass("upload-dnd_msg_show"),s(t,!1))}).on("dragGlobalEnd",function(){var t,e=S.active();if(e)e.upload_inited&&e.menu.content().removeClass("upload-dnd_msg_show");else for(t=0;t<v.length;++t)(e=v[t])&&e.state.form.removeClass("upload-dnd_msg_show")}).on("fileDragStart",".js-attach_dnd",function(){!0,s($(this),!0)}).on("fileDragEnd",".js-attach_dnd",function(){!1,s($(this),!1)}).on("pasteurl",".js-attach_dnd",function(t,e){var a=S.instance($(this));a&&a.loadImages(e.urls)}).on("files",".js-attach_dnd",function(t,e){var a,s,i,n,l,o;if(t.stopPropagation(),t.stopImmediatePropagation(),a=S.active())FileUploader.addFiles(e.files);else{for(a=S.instance($(this)),s={"image/pjpeg":Spaces.TYPES.PICTURE,"image/jpeg":Spaces.TYPES.PICTURE,"image/jpg":Spaces.TYPES.PICTURE,"image/gif":a.typeAllowed(Spaces.TYPES.FILE)?Spaces.TYPES.FILE:Spaces.TYPES.PICTURE,"image/png":Spaces.TYPES.PICTURE,"audio/mp3":Spaces.TYPES.MUSIC},i={},n=0;n<e.files.length;++n){if(l=e.files[n],o=Spaces.TYPES.FILE,l.name?o=Spaces.getFileType(l.name.split(".").slice(-1)):l.type&&(o=s[l.type.toLowerCase()]||Spaces.TYPES.FILE),l._spaces&&(o=l._spaces.type),!a.typeAllowed(o))return;i[o]||(i[o]=[]),i[o].push(l)}a&&(1<a.state.limit&&a.showProgress(!0),$.each(i,function(t,e){0<e.length&&(a.state.limit<2?(a.menu.open(),a.quickSelector(t,!0,function(){FileUploader.addFiles(e)},!0)):a.setupUploader(t,!1,function(){S.active(a),a.showProgress(!1),FileUploader.addFiles(e),S.active(null)}))}))}})},active:function(t){return t!==undefined&&(e=t),e},instance:function(t){return((t=$(t)).hasClass("js-attaches_form")?t:t.parents(".js-attaches_form")).data("AttachSelector")},destroy:function(){for(var t=0;t<v.length;++t)v[t].destroy();g=l=f=!(v=[]),n=0,o={},c={},e=null},delayedInit:function(){var a=this;s||(s=setTimeout(function(){$(function(){var t,e=$(".js-attach");for(t=0;t<e.length;++t)a.setup(e[t]);s=null})},0))},setup:function(t){var e=$(t);return e.data("AttachSelector")||e.data("AttachSelector",new S(e)),e.data("AttachSelector")}},Constructor:function(t){var e,a,s,i=this,n=t.data("form")?$(t.data("form")):t.parents("form"),l=t.data("list")?$(t.data("list")):n.hasClass("js-attaches")?n:n.find(".js-attaches"),o=$.extend({upload:!0},t.data(),l.data());n.hasClass("js-attaches_form")&&!t.data("allowAlias")||(v.push(i),i.new_attaches=[],i.default_selected=[],n.addClass("js-attaches_form").data("AttachSelector",i),o.fallback||(o.fallback=t.prop("href")),e=n.find(".js-attach"),a=[],e.length||(e=t),e.each(function(){$.each($(this).data("fileTypes"),function(t,e){$.inArray(+e,a)<0&&a.push(+e)})}),i.state={id:"",link:t,form:n,avatar:o.avatar,talkId:o.talk,commId:o.comm,exVideo:o.exVideo,onlyUpload:!!o.only_upload,onlyComm:o.comm&&o.only_comm,dir:o.dir,file_type:o.file_type,buttons:o.buttons,privateAttaches:!o["public"],allowedTypes:a,linkDownload:o.linkDownload,attaches:o.attaches===undefined||!!o.attaches,attachesList:l,proxyUpload:o.proxyUpload,fallbackUrl:o.fallback,upload:o.upload,spoiler:o.spoiler?"#"==o.spoiler[0]?$(o.spoiler):n.find(o.spoiler).first():"",noAutoSelect:o.noAutoSelect,oid:o.oid,ot:o.ot,pid:o.pid,limit:o.max_files||Spaces.LIMIT.ATTACHES},i.state.mode="picker",(i.state.attachesList.length||i.state.proxyUpload)&&(i.state.mode="attaches"),i.state.attaches&&(i.state.linkDownload=!0),i.state.flat=!0,i.state.spoiler&&i.state.spoiler.length?i.state.flat=!i.state.spoiler.data("wrap"):i.state.spoiler=!1,i.state.proxyUpload||(s=$(_.dndPlace()),i.state.form.addClass("js-attach_dnd").filesMonitor().prepend(s)),i.link=e,i.form=n,i.list=l,i.list.length&&"desktop"==Device.type&&i._initDragDrop(),i._setup())},_setup:function(){var t,s=this,i=new Spaces.DdMenu({flat:s.state.flat,data:{scroll:!0,spoiler:s.state.spoiler,toggle_same:!0}});s.link.each(function(){i.link($(this).data("no_label",!!s.state.spoiler))}),i.element().on("dd_menu_open",function(){if(i.opener().data("locked"))return!1}).on("dd_menu_toggle",function(t,e){var a=e.link.data("fileTypes");if(!e.sameLink&&a&&1==a.length)return i.close(),e.link.click(),!1}).on("dd_menu_opened",function(){var t,e,a=i.opener();m=s.state.onlyComm?"comm":Spaces.LocalStorage.get("attach_selector_source","comm"),(e=(t=a.data("fileTypes"))&&1==t.length&&t[0]||a.data("temp_type")||s.state.file_type)?(a.removeData("temp_type"),s.quickSelector(e)):(i.content().empty().append(_.typeSelect({types:s.state.allowedTypes})),Spaces.DdMenu.fixSize()),S.active(s)}).on("dd_menu_close",function(t){f?t.preventDefault():(0<s.new_attaches.length&&s.saveAttaches(s.new_attaches),s.free(),Spaces.fixHeight(),S.active(null),s.state.form&&s.state.form.trigger("AttachSelectorClose"))}).on("click",".js-select_file",function(t){t.preventDefault(),t.stopPropagation(),s.quickSelector($(this).data("type"),!0)}).on("click",".js-qsel_upload_btn",function(t){var e,a;if(t.stopImmediatePropagation(),s.state.uploadError&&(t.preventDefault(),t.stopPropagation(),s.showError(s.state.uploadError)),FilesUploader.needStaticUpload()){if(s.state.fallbackUrl instanceof $)return s.state.fallbackUrl.one("click",function(t){t.stopPropagation(),t.stopImmediatePropagation()}).click(),!1;if(s.state.fallbackUrl)return location.assign(s.state.fallbackUrl),!1;if(e=s.link,/^input|button$/i.test(e[0].tagName)||(e=e.find('button, input[type="submit"]').first()),a=e.parents("form"),e.length&&a.length)return Spaces.DdMenu.close(),s.link.data("disabled",!0),setTimeout(function(){a.on("submit._att_select",function(t){t.stopPropagation(),t.stopImmediatePropagation()}),a.addClass("no_ajax"),a.data("preventSubmit",!0),e.trigger("click",{ignoreEvent:!0}),tick(function(){a.data("preventSubmit",!1),a.off("submit._att_select")})},0),!1;s.showQSelError(L("Загрузка файла не реализована. Сообщите в <a href='/soo/support'>Support</a>"))}}).on("click",".js-attach_source",function(t){t.preventDefault(),t.stopPropagation(),m=$(this).data("source"),Spaces.LocalStorage.set("attach_selector_source",m),s.free(),s.quickSelector(s.current_type)}).on("click",".js-qsel_back",function(t){t.preventDefault(),t.stopPropagation();var e=$(this).data("back_view");"exit"==e?i.close():s.view(e,!0)}).on("click",".js-qsel_download_url_btn",function(t){t.preventDefault(),t.stopPropagation(),$(this).attr("disabled")||s.loadUrl()}).on("click",".js-qsel_select_btn",function(t){t.preventDefault(),t.stopPropagation(),$(this).hasClass("disabled")||(s.sliderSelect(),i.close())}).on("click",".js-qsel_select_music",function(t){var e;return t.preventDefault(),t.stopPropagation(),e=Spaces.core.extractFile($(this)),s.state.limit<2?s.checkParentLimit()?s.onAttachSelect(e)&&i.close():s.markMusic(e.nid,!1):(s.markMusic(e.nid)?(s.deleteAttach(e.nid,e.type),s.showQSelError("")):s.getAvail()<0&&(s.markMusic(e.nid,!1),s.limitError()),s._showSelectBtn()),!1}).on("click",".js-qsel_all",function(t){var e,a;if(t.preventDefault(),t.stopPropagation(),1<s.state.limit){if((e=s.getAvail())<=0)return void s.limitError();s.sliderSelect()}else if(!s.checkParentLimit())return;$(this),s.view("main").find(".js-qsel_all_spinner").removeClass("hide"),a={},"mail"==s.state.avatar?a.Talk_logo=1:"comm"==s.state.avatar?a.Comm_logo=1:"user"==s.state.avatar?a.User_photo=1:"picker"==s.state.avatar&&(a.Ad_photo=1),require("files_selector",function(){FilesSelector.open({attaches:!0,commId:s.state.commId,talkId:s.state.talkId,commSection:"comm"==m||s.state.onlyComm?0:1,hideTabs:s.state.onlyComm,type:s.current_type,maxFiles:e,apiData:a,onFileMultiSelect:function(t){for(var e=0;e<t.length;++e)s.onAttachSelect(Spaces.core.fixFile(t[e]));s.saveAttaches(s.new_attaches),s.new_attaches=[]},onExit:function(){i.close()}})})}).on("input change paste keydown",".js-qsel_link_input",function(t){tick(function(){s._showSelectBtn()})}),(t=s.state.spoiler)&&(t.after(i.element().detach().addClass(t.attr("class"))),t.remove()),s.menu=i},showProgress:function(t){this.state.attachesList.find(".js-tmp_pg_spinner").remove(),t&&this.state.attachesList.prepend(_.spinner3()),this.checkAttList()},setSection:function(t){this.menu.content().find(".list-link.js-attach_source.clicked").removeClass("clicked"),this.menu.content().find('.list-link.js-attach_source[data-source="'+t+'"]').addClass("clicked"),m=t},loadImages:function(t,n){var e,a,s,i,l,o=this,c=function(t){n&&o.showError(t)};if(o)if(pushstream.avail())if(h)c(L("Подождите окончаения предыдущей загрузки по ссылке."));else{if("attaches"!=o.state.mode||o.getAvail()){for(e=RegExp("(\\.|^)("+location.hostname.replace(/(\.)/g,"\\$1")+")(\\.?)$","i"),a=0;a<t.length;++a)if(s=t[a],e.test(s.domain))c(L("Cсылка не поддерживается."));else if(n||!1!==r[s.url]){h={url:s.url,time:Date.now()};break}return!!h&&(h.photo="picker"==o.state.mode,h.callback=function(t,e,a){var s,i=h;h=null,n?f=!1:o.showProgress(!1),s=t.data?Spaces.core.fixFile(t.data):t,i.timeout&&clearTimeout(i.timeout),s&&!s.blocked?(o.state.privateAttaches&&(s._private_attach=!0),r[i.url]=s,o.onAttachSelect(s,!0)&&o.saveAttaches([s]),o.menu.close()):(c(a||L("Ссылка не содержит поддерживаемых файлов.")),t&&console.log("[getImage] "+i.url+" - "+(s&&s.blocked?"file blocked":"invalid upload answer")),e||(r[i.url]=!1),o.checkComplete())},!(i=r[h.url])||i._private_attach&&!o.state.privateAttaches?(n?(f=!0,o.view("upload_progress",!0)):o.showProgress(!0),l={link:h.url,Ss:o.state.dir===undefined&&o.state.privateAttaches,CK:null},h.photo&&(l.Type=Spaces.TYPES.PICTURE),o.state.commId?l.Comm=o.state.commId:o.state.talkId&&(l.Talk=o.state.talkId),Spaces.api("files.getImage",l,function(t){h&&(0!=t.code?(console.log("[getImage] "+h.url+" - error"),c(Spaces.apiError(t)),h.callback(!1)):(h.time=Date.now(),t.data?(console.log("[getImage] "+h.url+" - OK (exists)"),h.callback(t)):(console.log("[getImage] "+h.url+" - queued"),h.timeout=setTimeout(function(){h.callback(!1)},u))))},{retry:3,onError:function(t){h.callback(!1,!0),console.log("[getImage] "+h.url+" - net error"),c(t)}})):h.callback(i),!0)}c(L("Превышен лимит количества файлов. Максимально можно прикрепить {0}. ",numeral(o.state.limit,[L("$n файл"),L("$n файла"),L("$n файлов")])))}else c(L("Ошибка подключения. Проверьте ваш интернет."))},stripUrls:function(t){var e,a=this,s=a.getAttaches(),i=r[$.trim(t)]||r["http://"+$.trim(t)];if(i){if(!a.state.privateAttaches&&i._private_attach)return t;for(e=0;e<s.length;++e)if(s[e].nid==i.nid&&s[e].type==i.type)return""}return t},quickSelector:function(n,t,e,l){var a,o=this,c=o.menu.content().empty(),r=$(_.quickSelector({type:n,showSlider:!o.state.onlyUpload,upload:o.state.upload,attachBtnName:o.state.proxyUpload?L("Вставить"):L("Добавить"),sources:o.state.commId&&!o.state.onlyComm,attaches:"attaches"==o.state.mode,linkDownload:o.state.linkDownload&&(n==Spaces.TYPES.PICTURE||n==Spaces.TYPES.VIDEO)}));r.find(".js-qsel_link_input").keypress(function(t){t.keyCode!=Spaces.KEYS.ENTER&&t.keyCode!=Spaces.KEYS.MAC_ENTER||(t.preventDefault(),r.find(".js-qsel_select_btn").click())}),o.setUploadErr(null),o.state.buttons&&r.find(".qsel-cust_btn").replaceWith($(o.state.buttons).children().clone()),c.addClass("js-attach_dnd").append(r),l||o.view("main",!0),o.current_type=n,o.setSection(m),Spaces.DdMenu.fixSize(),Loader.loaded("attach_selector_deps")||o.setLoadling(!0),a=function(){var i,a,s;l||o.setLoadling(!1),o.slider=null,o.state.onlyUpload||(n==Spaces.TYPES.MUSIC?(o.slider=null,r.find(".js-qsel_carousel").html(_.spinner()),(i={Type:Spaces.TYPES.MUSIC,Lt:Spaces.FILES_LIST.FILES_ALL,O:0,L:4}).user=Spaces.params.name,o.state.commId?(i.Comm=o.state.commId,i.Default="comm"==m&&t,i.Section="comm"==m?0:1):o.state.talkId&&(i.Talk=o.state.talkId),Spaces.api("neoapi/files.getFiles",i,function(t){var e,a,s;if(o.setUploadErr(t.uploadError),0==t.code){if("Section"in t&&(t.Section==i.Section||o.state.onlyComm||o.setSection(p[t.Section])),r.find(".js-qsel_carousel").replaceWith(_.musicList({files:t.widgets})),r.find(".js-qsel_cnt").text(t.count).removeClass("hide"),e=o.getAttaches(!0)[n])for(a=0;a<e.length;++a)o.markMusic(e[a].nid);Spaces.DdMenu.fixSize()}else s=Spaces.apiError(t),t.code==Codes.FILES.ERR_DIR_ACCESS_DENIED&&"comm"==m&&(s=_.disabledUploadError()),r.find(".js-qsel_main").html(_.error({text:s,back:"exit"}))})):((i={Type:n,Psize:Spaces.PREVIEW.SIZE_81_80,Lt:Spaces.FILES_LIST.FILES_ALL,Mode:n==Spaces.TYPES.FILE?Spaces.RENDER_MODE.CAROUSEL:Spaces.RENDER_MODE.PREVIEW}).user=Spaces.params.name,o.state.commId?(i.Default="comm"==m&&t,i.Comm=o.state.commId,i.Section="comm"==m?0:1):o.state.talkId&&(i.Talk=o.state.talkId),a=!1,s=r.find(".js-qsel_carousel").carousel({select:!0,hasMore:!0,firstLoad:!0,gallery:!1,multiple:1<o.state.limit,limit:30,apiMethod:"neoapi/files.getFiles",metric:"attach_selector",apiData:i}).on("apiResult",function(t){o.setUploadErr(t.uploadError),"Section"in t&&(t.Section==i.Section||o.state.onlyComm||o.setSection(p[t.Section]))}).on("loadError",function(t){var e=t.message||L("Неизвестная ошибка загрузки.");if("api"==t.type&&t.res.code==Codes.FILES.ERR_DIR_ACCESS_DENIED){if(o.state.onlyComm)return o.menu.content().find(".js-qsel_all").hide(),s.resetItems(),s.insert($("<div>"+Spaces.apiError(t.res)+"</div>")),void s.update();"comm"==m&&(e=_.disabledUploadError())}r.find(".js-qsel_main").html(_.error({text:e,back:"exit"}))}).on("photosLoadChunk",function(){var t,e;if(s){if(s.totalItems()||(s.insert($("<div>"+L("У вас ещё нет загруженных {0}. ",d[n].title2)+"</div>")),s.update()),r.find(".js-qsel_cnt").text(s.totalItems()).removeClass("hide"),t=o.getAttaches(!0)[n])for(e=0;e<t.length;++e)s.markSelected(t[e].nid);a||(a=!0,Spaces.DdMenu.fixSize())}}).on("firstPhotosLoad",function(){tick(function(){Spaces.DdMenu.fixSize()})}).on("selectFile",function(t,e){var a;if(s&&e.nid)return o.state.limit<2?o.checkParentLimit()?o.onAttachSelect(e)&&o.menu.close():s.toggleSelected(e.nid,!1):(a=!s.isSelected(e.nid),o._showSelectBtn(),a?(o.deleteAttach(e.nid,e.type),o.showQSelError("")):o.getAvail()<0&&(s.toggleSelected(e.nid,!1),o.limitError()),Spaces.DdMenu.fixSize()),!1}),o.slider=s,Spaces.DdMenu.fixSize())),o.state.form.trigger("AttachSelectorOpen",{ui:c}),setTimeout(function(){Spaces.DdMenu.fixSize(),e&&e()},0)},o.setupUploader(n,l?null:a,l?a:null)},setupUploader:function(l,t,o){var c=this,e=function(t){var e,a,s,i,n=new Url(t.url);c.state.dir!==undefined?n.query.dir=c.state.dir:(n.query.Att=1,c.state.privateAttaches&&(n.query.Ss=1)),c.state.commId&&"comm"==m&&(n.query.Comm=c.state.commId),c.state.talkId&&(n.query.Talk=c.state.talkId),e=c.view("main"),a=c.view("upload"),e&&((s=e.find(".js-qsel_upload_btn")).find(".js-upload_btn_ico").removeClass("hide"),s.find(".js-upload_btn_spinner").addClass("hide"),s.removeClass("disabled")),FilesUploader.needStaticUpload()||(i=t.maxFileWeightByDuration,FileUploader.setup({name:"myFile",action:n.url(),multiple:!0,denyUpload:t.FileExtWithRateRestrictionsForUpload,inlineFileWidget:c.state.limit<2,maxFiles:c.state.limit,maxSize:1024*t.maxSize*1024,maxShortVideoSize:i?1024*i.Weight*1024:0,maxShortVideoDuration:i?i.Duration:0,uploadDrag:c.menu.content(),selectButton:!!e&&s,uploadWidget:!!a&&a.find(".js-qsel_upload_widget"),buttonClass:{hover:"strong_clicked",active:"strong_clicked_active"},type:l,mode:FileUploader.MODES.BUTTON}),c.upload_inited=!0),o&&o()};c.upload_inited=!1,require("attach_selector_deps",function(){S._initUploader(),t&&t(),Spaces.api("neoapi/files.getUploadInfo",{Type:l},function(t){0==t.code&&e(t)},{cache:!0,cacheTime:1200,retry:20})})},onAttachUpload:function(t,e){var a,s=this;s.state.attaches&&((a=s.list.find(".js-attaches__upload")).length||s.list.prepend(a=$('<div class="js-attaches__upload">')),a.append(e))},onAttachSelect:function(t,e,a){var s,i,n=this,l=new $.Event("onNewAttach");return n.state.form.trigger(l,{file:t}),!l.isDefaultPrevented()&&(a&&n.state.form.trigger("onNewAttachBb",{file:t}),ge("#"+t.nid+"_"+t.type)?n.state.limit<2:(n.state.limit<2&&(n.deleteAll(),n.new_attaches=[]),n.state.attaches&&(s=n.list.find(".js-attaches__tile"),i=n.list.find(".js-attaches__plain"),s.length||n.list.append(s=$('<div class="js-attaches__tile attaches__wrap_tile">')),i.length||n.list.append(i=$('<div class="js-attaches__plain">')),t.show_preview?s.append(_.attach(t)):i.append(_.attach(t)),s.toggle(0<s.find(".js-attach_item:first").length),i.toggle(0<i.find(".js-attach_item:first").length)),e||n.new_attaches.push(t),n.checkAttList(),!0))},typeAllowed:function(t){return!this.state.allowedTypes||0<=$.inArray(+t,this.state.allowedTypes)},setUploadErr:function(t){var e=this.view("main");this.state.uploadError=t,e&&t&&(e.find(".js-qsel_upload_err").removeClass("hide").html(t),e.find(".js-qsel_upload_btn, .js-qsel_link_upload").addClass("hide"))},showError:function(t){var e=this.view("action",!0);return e?e.html(_.error({text:t})):Spaces.showError(t)},showQSelError:function(t){var e=this,a=e.view("main",!0).find(".js-qsel_error").html(t?_.error({text:t,no_button:!0}):"");return Spaces.DdMenu.fixSize(),a},setLoadling:function(t){var e=this;e.view("action")&&(t?(e.loading_last_view=e.last_view_name,e.view("action",!0).append(_.spinner())):e.view(e.loading_last_view,!0))},sliderSelect:function(){var t,e=this,a=e.getSelected();for(t=0;t<a.length;++t)e.onAttachSelect(Spaces.core.extractFile(a[t]))},saveAttaches:function(a){var e,t,s=this;a.length&&(e=function(t){if(s.state.attaches&&--n,s.checkComplete(),t)s.renderAttach(t.tiles,t.list);else for(var e=0;e<a.length;++e)s.deleteAttach(a[e].nid,a[e].type,!0)},s.state.attaches&&++n,s.form.trigger("onNewAttaches",{attaches:a,callback:function(t){e(t)}}),s.checkComplete(),s.state.ot&&(t={Oid:s.state.oid,Pid:s.state.pid,Ot:s.state.ot,Comm:s.state.commId,CK:null,atT:AttachSelector.getAttaches(s.state.form,!0)},Spaces.api("neoapi/attach.add",t,function(t){0!=t.code?(Spaces.showApiError(t),e(!1)):e(t.new_attaches)},{onError:function(t){Spaces.showError(t),e(!1)}})))},renderAttach:function(t,e){$.each($.extend(e,t),function(t,e){$("#"+t).replaceWith(e)}),$.isEmptyObject(t)||require("gallery",function(){GALLERY.addPhoto()}),this.checkAttList()},checkComplete:function(){AttachSelector.isBusy()||this.form.trigger("onAttachesComplete")},deleteAttach:function(t,e,a){var s,i,n=this,l=$("#"+t+"_"+e);0<l.length&&((s=S.parseFile(l)).noapi=!!a,l.remove(),n.state.form.trigger("onDeleteAttach",{file:s}),n.state.ot&&!a&&(i={Oid:n.state.oid,Pid:n.state.pid,Ot:n.state.ot,Comm:n.state.commId,CK:null,File_id:t,Ft:e},Spaces.api("neoapi/attach.delete",i,function(t){0!=t.code&&Spaces.showApiError(t)})),n.checkAttList(),require("gallery",function(){GALLERY.addPhoto()}))},deleteAll:function(){var t,e=this,a=e.getAttaches();for(t=0;t<a.length;++t)e.deleteAttach(a[t].nid,a[t].type)},markMusic:function(t,e){var a,s=this,i=s.view("main").find('[data-nid="'+t+'"]').find(".ico_photo_selected, .ico_photo_select");return s.state.limit<2&&s.view("main").find(".ico_photo_selected").removeClass("ico_photo_selected").addClass("ico_photo_select"),a=i.hasClass("ico_photo_select"),(e!==undefined?e:a)?(i.removeClass("ico_photo_select"),i.addClass("ico_photo_selected")):(i.removeClass("ico_photo_selected"),i.addClass("ico_photo_select")),!a},getSelected:function(){var t,e=this;return e.slider?e.slider.getSelected():e.view("main")?(t=[],(e=this).view("main").find(".ico_photo_selected").each(function(){t.push($(this).parent())}),t):[]},setParent:function(t){this.parent=t},getAvail:function(){return this.state.limit-this.getTotal()},getTmpCnt:function(){return this.list.find(".js-attaches__upload").children().length},getTotal:function(){var t,e,a,s,i,n,l,o=this;if(o.parent&&!o.parent.getAvail())return o.state.limit;for(t=o.getAttaches(),e=o.getSelected(),a=o.getTmpCnt(),s={},i=t.length+a,n=0;n<t.length;++n)s[t[n].nid+":"+t[n].type]=1;for(n=0;n<e.length;++n)s[(l=Spaces.core.extractFile(e[n])).nid+":"+l.type]||++i;return i},getAttaches:function(a){var t,e,s=this,i=a?{}:[];if(s.state.attaches)return s.list.find(".js-attach_item").each(function(){var t=$(this),e=S.parseFile(t);e.el=t,a?(i[e.type]||(i[e.type]=[]),i[e.type].push(e)):i.push(e)}),i;for(t=0;t<s.default_selected.length;++t)e=s.default_selected[t],a?(i[e.type]||(i[e.type]=[]),i[e.type].push(e)):i.push(e);return i},checkAttList:function(){var t,e,a,s,i=this,n=0<i.list.find(".js-attach_item:first").length||0<i.list.find(".js-attaches__upload").children().length,l=0<i.list.find(".js-tmp_pg_spinner").length;i.list.toggle(n||l),i.form.find(".js-attaches_show").toggleClass("hide",!l&&!n),e=0<(t=i.list.find(".js-attaches__tile")).children().length,s=0<(a=i.list.find(".js-attaches__plain")).children().length,t.toggle(e),a.toggle(s),i.form.trigger("onAdultAttach",{hasAdult:0<i.list.find('[itemprop="requiredMinAge"]').length})},selectDefault:function(t,e){var a=this;a.state&&(a.slider?a.slider.markSelected(t):a.markMusic(t),a.state.limit<2&&(a.default_selected=[]),a.default_selected.push({nid:t,type:e,id:t+"_"+e}))},view:function(t,e){var a,s,i,n,l,o,c=this;if(t===undefined)return c.last_view_name;if(!c.views_cache||$.isEmptyObject(c.views_cache))for(c.views_cache={},a=c.menu.content().find("[data-view]"),s=0;s<a.length;++s)i=$(a[s]),c.views_cache[i.data("view")]=i;if(t===c.last_view_name||!e)return c.views_cache[t];for(l in c.views_cache)o=c.views_cache[l],l===t?(n=o).show():(l===c.last_view_name&&o.data("empty")&&o.empty(),o.hide());return c.last_view_name=t,tick(function(){Spaces.DdMenu.fixSize()}),n},lock:function(t){this.menu.close(),this.state.link.data("locked",t)},_showSelectBtn:function(){var t,e,a,s,i,n=this,l=n.view("main");l&&(t=l.find(".js-qsel_select_btn"),e=l.find(".js-qsel_download_url_btn"),a=l.find(".js-qsel_link_input"),s=0<$.trim(a.val()).length,i=Spaces.checkUrl(a.val()),t.toggleClass("disabled",1<n.state.limit&&!n.getSelected().length),s&&i?e.removeAttr("disabled"):e.attr("disabled","disabled"),a.toggleClass("text-input_error text-input_error_bg",s&&!i),Spaces.DdMenu.fixSize())},loadUrl:function(){return this.loadImages(Spaces.extractUrls(this.view("main").find(".js-qsel_link_input").val()),!0)},limitError:function(t){t=t||this.state.limit,this.showQSelError(L("Превышен лимит количества файлов. Максимально можно прикрепить {0}. ",numeral(t,[L("$n файл"),L("$n файла"),L("$n файлов")])))},checkParentLimit:function(){return!this.parent||(!!this.parent.getAvail()||(this.limitError(this.parent.state.limit),!1))},close:function(){this.menu.close()},free:function(){var t=this;t.menu&&t.menu.content().empty(),t.slider&&(t.slider=null),t.new_attaches=[],t.default_selected=[],t.views_cache=t.last_view_name=null,f=!1},destroy:function(){this.free(),this.menu=null},ok:function(){return!!this.menu},_initDragDrop:function(){var s,e,i,a,n,l,o,c=this,r=!1,d=$('<div style="display: inline-block">&nbsp;</div>'),p=$("<div>").css({position:"absolute",cursor:"pointer",background:"rgba(255, 255, 255, 0)",top:0,bottom:0,left:0,right:0,zIndex:999999999}),u=function(){o=c.state.form.find("textarea").findByPos(a),n[0].style.opacity=o?1:.5};c.list.draggable({realtime:!0,fastEvents:!0,disableContextMenu:!1,forceStart:!0,scroll:!0,events:{dragStart:function(t){(n=c.list.find(".js-attach_item").findByPos({x:t.x,y:t.y}))&&(s=n.prop("style").cssText,r=!1,i=setInterval(u,250),l={x:t.x-n.offset().left,y:t.y-n.offset().top,w:n.width(),h:n.height()})},dragMove:function(t){n&&(r||(e=n.position(),d.outerWidth(n.outerWidth()).outerHeight(n.outerHeight()),n.after(d),c.list.after(p),n.css({position:"absolute",left:0,top:0,right:0,bottom:0,userSelect:"none",width:n.width(),height:n.height(),zIndex:999999999,cursor:"pointer",opacity:.5}),r=!0),$.support.nativeAnim?n.transform({translate:[e.left+t.dX,e.top+t.dY]}):(n[0].style.left=e.left+t.dX+"px",n[0].style.top=e.top+t.dY+"px"),a={x:t.x-l.x,y:t.y-l.y,w:l.w,h:l.h})},dragEnd:function(t){var e,a;n&&(i&&clearInterval(i),i=null,r&&(d.detach(),p.detach(),$.support.nativeAnim&&n.transform(),n.prop("style").cssText=s,t.trueTouch||((e=n).one("click._prevent_click",function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation()}),tick(function(){e.off("._prevent_click")})),o&&(a=S.parseFile(n),o.trigger("onDropAttach",a)),o=n=null))}}})}}),window.AttachSelector={resetAttaches:function(t){$(t).find(".js-attaches").empty().hide()},getAttaches:function(t,a){var s=[];return(t=$(t)).find(".js-attach_item").each(function(){var t=$(this),e=S.parseFile(t);a?s.push(e.nid+"_"+e.type):(e.el=t,s.push(e))}),s},select:function(t,e){var a=S.active();a&&a.selectDefault(t,e)},resetSelected:function(t,e){self.default_selected=[]},instance:function(t,e){return S.instance(t)},isBusy:function(){return l||h||0<n},isOpened:function(){return!!S.active()},onDone:function(t){this.isBusy()?$("#main").one("onAttachesComplete",function(){t()}):t()},close:function(){var t=S.active();t&&t.close()}},define("attach_selector","onRequire",function(){S.delayedInit()}),define("attach_selector","onRequest",function(){$(function(){S.init(),page_loader.onShutdown("attach_selector",function(){S.destroy()})})}))});