define("msg_fc","init",function(){Spaces.MsgFlowControl=function(t){function i(n){t.onReset&&t.onReset(),Spaces.cancelApi(s),f=s=!1,a=[]}function o(n){!n!=!u&&(u&&(clearInterval(u),u=null),n&&(u=setInterval(function(){c()},t.interval/4),e=Date.now()))}function c(n){if(!f&&(n||u&&Date.now()-e>=t.interval)){if(t.focus&&!Spaces.notifications.isWindowActive())return void(l=!0);f=!0,s=t.onRefresh({done:function(){e=Date.now(),f=!1},fail:function(){e=Date.now(),f=!1},retry:function(){e=Date.now(),c(!(f=!1))}})}}var s,f,u,n=this,a=[],e=Date.now(),r=".msg_fc"+e,l=!1;(t=$.extend({onCheck:null,onRequest:null,onRefresh:null,onReset:null,interval:3e4,focus:!1},t)).focus&&$("body").on("focuswindow"+r,function(){l&&c(!(l=!1))}),o(!window.pushstream||!window.pushstream.avail()),window.pushstream&&pushstream.on("connect","msg_fc"+r,function(n){n.first||(i(),c(!0)),o(!1)}).on("disconnect","msg_fc"+r,function(){pushstream.disabled()||(o(!0),i())}),n.get=function(n){var o,e;if(!u){for(o=0;o<n.length;++o)t.onCheck&&!t.onCheck(n[o])||a.push(n[o]);if(!f&&a.length){if(t.focus&&!Spaces.notifications.isWindowActive())return void(l=!0);(e=a).pag,i(),f=!0,s=t.onRequest({queue:e,done:function(){f=!1},fail:function(){f=!1,i(),c(!0)}})}}},n.destroy=function(){i(),window.pushstream&&pushstream.off("connect","msg_fc"+r).off("disconnect","msg_fc"+r),$("body").off("focuswindow"+r),a=null},n.refresh=function(){c(!0)}}});