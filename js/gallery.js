define("gallery","init",function(){function p(e){return e.gallery_cache_id&&ue[e.gallery_cache_id]||Spaces.File.getMeta(e)}function P(){ke||(ke=!0,setTimeout(function(){ke=!1},130))}function Y(e,a,t,i,r,l,o){var n=Math.max(r*a-e.w,0)/2,s=Math.max(l*a-e.h,0)/2,g=n<Math.abs(t),c=s<Math.abs(i);return o&&(n<t?t=o?n:t+(n-t)/te:t<-n&&(t=o?-n:t-(n+t)/te)),s<i?i=o?s:i+(s-i)/te:i<-s&&(i=o?-s:i-(s+i)/te),z<a?a=o?z:a+(z-a)/te:a<1&&(a=o?1:a+(1-a)/te),{x:t,y:i,overX:g,overY:c,scale:a}}function r(e,a,t){var i,r=new Image;return r.src=e,r.id=a,r.className="gallery__image",D(i=$(r),e,t),i}function Z(e,a,t){var i=r(a,e.attr("id"),e.parent());return e.replaceWith(i),i}function D(e,a,t){if(!oe)return a===undefined?a=ICONS_BASEURL+"preloader_dark.gif":ce[a]=!0,void e.prop("src",a);if(a===undefined)return e.prop("src",A).removeData("o_src"),void c(e,t);var i=e[0],r=$.data(i,"o_src");$.prop(i,"src");if(r!=a){if(!ce[a])return i.src=A,$.data(i,{src:a,o_src:a}),c(e,t),void s(a);i.src=a,$.data(i,"o_src",a)}ce[a]&&c(e,t)}function l(e,a){var t,i=de[e];if(i){for(t=0;t<i.length;++t)i[t](e,a);delete de[e]}}function s(e,a){var t,i;if(a&&(de[e]||(de[e]=[])).push(a),ce[e])l(e,!0),d(e);else{if(t=Date.now(),ge[e]&&t-ge[e]<1e3)return;delete se[e],ge[e]=Date.now(),(i=new Image).onload=function(){i=null,ce[e]={width:this.width,height:this.height},d(e),l(e,!0),delete ge[e],se[e]&&(delete se[e],X&&De.update(!0))},i.onerror=function(){i=null,delete ge[e],ce[e]||(se[e]=!0,X&&De.update(!0)),l(e,!1)},i.src=e,i=null}}function o(e,a,t,i){return t<e||i<a?a<e?[+t,Math.round(t/e*a)]:[Math.round(i/a*e),+i]:[+e,+a]}function n(e,a,t,i){var r=e/a;return i<a&&(e=(a=i)*r),t<e&&(a=(e=t)/r),[Math.round(e),Math.round(a)]}function g(e){if(e){var a=e.match(/\.\w+\.(\d+)\.(\d+)/);return a&&[a[1],a[2]]}}function W(e,a,t){var i=e.offset();return!!(i&&a>=i.left&&a<=i.left+e.outerWidth()&&t>=i.top&&t<=i.top+e.outerHeight())}function c(e,a){var t=!ce[e.data("o_src")];!t&&e.data("src")&&(e.prop("src",e.data("src")),e.removeData("src").removeAttr("width").removeAttr("height")),(a||e.parent()).toggleClass("gallery-img_loading",!!t)}function d(e,a){var t,i;for(t=0;t<C;++t)(i=$("#gallery_img_"+t)).data("o_src")==e&&c(i)}function E(){var e=a();return{x:0,y:b?0:k,h:e-(b?0:k+I),rh:e,w:U.innerWidth()}}function x(){return a()-(b?0:k+I)}function a(){return j?screen.availHeight:$("#Gallery").height()}function u(e,a){return e-Math.floor(e/a)*a}var X,H,N,b,O,_,U,m,f,y,h,t,A=ICONS_BASEURL+"transparent.gif",k=50,I=50,v="ucbrowser"==Device.type,w=50,M=1,S=2,V=66,C=3,i="rgba(69, 69, 69, 0.95)",z=3,q=.212,B=300,K=300,J=150,G=200,Q=9,ee=100,ae=.35,te=1.5,ie=1.5,re=5,T=[["ico_gallery_vote_up","ico_gallery_vote_up_on"],["ico_gallery_vote_down","ico_gallery_vote_down_on"]],j=""+window.operamini=="[object OperaMini]",R=!cookie.get("gal_no_transp")&&Device.css("box-shadow","0px 0px 0px #000",/\d\w/),le="desktop"==Device.type&&R,F=!!navigator.userAgent.match(/(MSIE 7.0|Opera Mini)/i)||j,oe=!F&&$.support.nativeAnim&&!("firefox"==Device.browser&&"touch"==Device.type),ne=oe,se=(Device.type,{}),ge={},ce={},de={},_e={},me={},ue={},pe={},fe={},ye={},he={},ve=0,we=0,xe=0,be=0,$e=[!1,!1,!1],ke=!1,Ie=!1,Me=!1,Se=!1,Ce=!1,Le={playerStub:function(e){return'<div class="player-dummy_wrap" id="galleryVideoStub"><div class="player-dummy"><img src="'+e.preview+'" alt="" /></div></div>'},gallery:function(e){var a=j?"a":"div",t=(e.arrowSmall,e.arrowSmall,'<div id="Gallery" class="gallery'+(F?" not_centered":"")+'"><div class="gallery__page_shadow"></div><div class="gallery__shadow"></div><'+a+' class="gallery__side gallery__side_prev js-gallery_arrow" data-dir="-1" href="#gprev"><div class="gallery__side-arrow ico_gallery ico_gallery_arrow_left"></div></'+a+"><"+a+' class="gallery__side gallery__side_next js-gallery_arrow" data-dir="1" href="#gnext"><div class="gallery__side-arrow ico_gallery ico_gallery_arrow_right"></div></'+a+'><div class="gallery__fs_header"><div class="gallery__fs_btn js-gallery_cnt"></div><a class="gallery__fs_btn right js-gallery_fullscreen" href="#fullscreen"><span class="ico_gallery ico_gallery_exit"></span></a></div><div class="gallery__loader"></div><div class="gallery__header" id="gallery_tools"><table class="gallery_cnt-table"><tr><td><div class="gallery_cnt js-gallery_cnt"></div></td></tr></table><div class="gallery__header_inner"><a class="gallery__tools_button" href="" target="_blank" rel="noopener" id="g_dloadlink"><span class="ico_gallery ico_gallery_download m"></span></a><div class="gallery__tools_place">&nbsp;</div>'+("desktop"==Device.type?'<a class="gallery__tools_button" href="#zoom" id="gallery__zoom"><span class="ico_gallery ico_gallery_zoom m"></span></a><a class="gallery__tools_button js-gallery_fullscreen" href="#fullscreen"><span class="ico_gallery ico_gallery_fullscreen m"></span></a>':"")+'<a class="gallery__tools_button" href="#gallery_exit" id="gallery__exit"><span class="ico_gallery ico_gallery_exit m"></span></a></div></div>'+(F?'<table class="gallery__wrapper" id="Gallery__wrapper"><tr><td>':"")+'<div id="gallery-container" class="accel-3d"><div id="gallery_close_msg"><span id="gallery_close_text">'+Le.closeMsg()+'</span><span id="gallery_closed_text">'+Le.closeMsg(!0)+'</span></div><div id="gallery_img_0_wrap" class="gallery-anim_hide gallery__image-wrapper accel-3d gallery-sibling"><img src="'+A+'" alt="" id="gallery_img_0" class="gallery__image" /><div class="gallery__error gallery__image"></div></div><div id="gallery_img_1_wrap" class="gallery-anim_hide gallery__image-wrapper accel-3d"'+(F?' style="margin: 0"':"")+'><img src="'+A+'" alt="" id="gallery_img_1" class="gallery__image" /><div class="gallery__error gallery__image"></div><center id="galleryVideo"></center></div><div id="gallery_img_2_wrap" class="gallery-anim_hide gallery__image-wrapper accel-3d gallery-sibling"><img src="'+A+'" alt="" id="gallery_img_2" class="gallery__image" /><div class="gallery__error gallery__image"></div></div></div>'+(F?"</td></tr></table>":"")+(j||"desktop"==Device.type?"":'<div class="gallery__descr hide" id="gallery_descr_wrap"><div class="gallery__descr_text" id="gallery_descr"></div></div>')+'<div class="gallery__footer" id="gallery_bottom"><table class="gallery__footer_table"><tr><td class="gallery__link"><a href="" id="g_advancepage"><span class="ico_gallery ico_gallery_mess"></span> <span id="g_commentCnt" class="gallery__link_text"></span></a></td><td class="first gallery__link" id="g_sharelink_inner"><a href="" id="g_sharelink" title="'+L("Сохранить к себе")+'"><span class="ico ico_plus_white"></span> <span id="g_shareCnt" class="gallery__link_text"></span></a></td>'+("desktop"==Device.type?'<td class="pointer js-descr_wrap"><div class="gallery__descr_text hide" id="gallery_descr_wrap"><div id="gallery_descr"></div></div></td>':"")+'<td class="gallery__link"><a href="#glup" class="js-vote_btn" data-type="1" mode="gallery"><span class="ico_gallery '+T[0][0]+'"></span> <span class="js-vote_btn_cnt gallery__link_text"></span></a></td><td class="last gallery__link"><a href="#gldown" class="js-vote_btn" data-type="-1" mode="gallery"><span class="ico_gallery '+T[1][0]+'"></span> <span class="js-vote_btn_cnt gallery__link_text"></span></a></td></tr></table></div><div class="gallery__loader_shadow"></div><div class="gallery__shadow_error" id="Gallery_error"></div></div>');return t},error:function(e){return'<div class="gallery-error_msg">'+e+"</div>"},loadError:function(e){return'<div class="gallery__error_inner">'+e.message+(e.action?'<br /><a href="#g-adult-show" class="gallery__button js-gallery_repeat" data-action="'+e.action+'"><span class="ico_gallery ico_gallery_reload m"></span> <span class="m">'+L("Повторить")+"</span></a>":"")+"</div>"},retry:function(){return'<div><a href="#g_retry" class="gallery__button"><span class="ico_gallery ico_gallery_reload m"></span> <span class="m">'+L("Повторить")+"</span></a></div>"},closeMsg:function(e){return e?L("Отпустите, чтобы закрыть..."):L("Потяните, чтобы закрыть...")},adult:function(e){var a="video"==e.content?L("Показать видео"):L("Показать фото"),t='<div class="gallery__error_inner">'+L("Внимание! Эти материалы только для взрослых! ")+L("Нажимая &quot;{0}&quot;, вы подтверждаете, ",a)+L("что вам 18 или более лет.")+'<br /><a href="#g-adult-show" class="gallery__button js-adult"><span class="ico_gallery ico_gallery_eye m"></span> <span class="m">'+a+"</span></a></div>";return t},notif:function(e){return'<div id="gallery_notif"><div class="gallery__notif_inner word_break">'+e.text+'<a href="#gnc" class="gallery__notif_close"><span class="ico_gallery ico_gallery_exit js-gallery_notif_close"></span></a></div></div>'},collectionsMotivator:function(){return'<div class="t_center">Сохраните этот файл в свою коллекцию. Нажмите кнопку <span class="ico ico_plus_white ico_no-mrg m pointer js-gallery_collaction"></span></div>'}},De=new(Class({Implements:[TSimpleEvents],init:function(){var t=this;page_loader.ok()&&page_loader.onJSC("gallery",function(a){tick(function(){require("gallery",function(){if(a.match(/^[\/\d+\w+:_-]+$/)){var e=a.split("/");2==e.length&&t.open(e[0],e[1],!0)}})})},!0),page_loader.on("shutdown","removegallery",function(){me={},pe={},ue={},fe={},ye={},he={},t.off(!1)}),_e={},se={},ge={},ce={},$(".js-gallery_skip").each(function(){var e=$(this).find(".gview_link:first");e.length&&(_e[p(e).gid]=1)})},open:function(e,a,t,i){var r,l,o,n,s=this;if(a=+a,Device.android_app&&s.pullToRefresh(!1),t&&pe[e]&&(a=pe[e][a-(he[e]||0)]),H=null,X&&e==X.gid&&a==X.id)s.update();else{if(y=f=!1,r=!($e=[!1,!1,!1]),!X){if(ve=0,O=b=!1,Se=ke=Ie=!1,l=Date.now(),i||(we=$(window).scrollTop(),le||$("html, body").scrollTop(0)),r=!0,page_loader.ok()&&!t&&page_loader.setJSC(!1),!me[e]||!me[e][a])return void console.warn("[gallery] not found: "+e+"/"+a);U=$(Le.gallery({mode:"normal",id:l})),o="video"==me[e][a].content,U.toggleClass("gallery__touch","desktop"!=Device.type&&!j).toggleClass("gallery__om gallery__arrows_hide",j),(n=$("#Gallery")).length?n.replaceWith(U):($("#main_wrap").append(U),$("body").addClass(le?"gallery__transp_open":"gallery__open"),$("html, body").addClass("gallery__doc")),m=$("#gallery-container"),Me=!o&&"operamini"!=Device.browser&&(oe||"touch"==Device.type),o||s.initGestures(),Me&&(o||s.initMouseScale(),U.toggleClass("gallery-anim",oe),$("#gallery-siblings").removeClass("hide")),U.on("click",".js-gallery_collaction",function(e){e.preventDefault(),s.hideNotif(),h=!0,tick(function(){$("#g_sharelink").click()})}).on("click",".js-adult",function(e){e.preventDefault();$(this);$.each(me,function(e,a){$.each(this,function(){delete this.adult})}),s.update(!0),Spaces.api("neoapi/session.adultCheck",{passed:1}),X.showOnAdult&&(X.showOnAdult(),delete X.showOnAdult)}).on("click",".js-gallery_repeat",function(e){var a,t,i;if(e.preventDefault(),"img"==(a=$(this).data("action")))X.currImage=Z(X.currImage,X.item.image),s.update(!0);else if("loader"==a)for(t=fe[X.gid].callbacks,s.setGroupError(X.gid,!1),i=0;i<t.length;++i)t[i]()}).on("like",function(e,a){if(X){var t=X.item.like.split(",");t[0]=a.polarity,t[1]=a.plus,t[2]=a.minus,X.item.like=t.join(","),s.syncLikes()}}).on("click",".disabled",function(e){e.preventDefault();var a=$(this).find("a").attr("id"),t="video"==X.item.content?L("видео"):L("фото"),i={g_advancepage:L("У этого {0} нет комментариев.",t),g_sharelink:Spaces.params.nid?L("Это {0} нельзя сохранять в коллекции.",t):Spaces.view.onlyAuthMotivator()};Spaces.showMsg(i[a],{gallery:!0,type:"alert"})}).on("click",".js-gallery_notif_close",function(e){e.preventDefault(),$("#gallery_notif").find(".js-gallery_collaction").length&&(h=!0),s.hideNotif()}).on("click",".js-descr_wrap",function(e){e.preventDefault(),$("#g_advancepage").click()}),"operamini"!=Device.browser&&(Spaces.params.nid||cookie.enabled())&&U.on("click","#g_sharelink",function(e){var a,t,i=$(this);i.parents("td").hasClass("disabled")||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),s.autoHideNotif(),h=!0,a=i.find(".ico"),t=function(){a.removeClass("ico_spinner"),FileCollections.open(X.item.type,X.item.extType,X.item.nid,"gallery")},Loader.loaded("collections")?t():(a.addClass("ico_spinner"),require("collections",t)))}),Date.now(),$(".js-gallery_arrow").on("click",function(e){if(e.preventDefault(),!ke&&1==X.scale){var a=+$(this).data("dir");s.move(a)}}),$(".js-gallery_fullscreen").on("click",function(e){e.preventDefault(),ke||(ke=!0,setTimeout(function(){ke=!1},300),O=!U.hasClass("gallery__fullcreen"),s.toggleFullscreen(O),U.toggleClass("gallery__fullcreen",O),s.onResize())}),$("#gallery__zoom").on("click",function(e){e.preventDefault(),ke||s.toggleZoom()}),$("#gallery__exit").on("click",function(e){e.preventDefault(),s.exit()}),$("#g_advancepage").on("click",function(e){var a=new Url(location.href),t=new Url(this.href);a.isSame(t)&&(e.preventDefault(),s.exit(!0))}),$("#main").on("like.gallery",function(){X&&s.syncLikes()}),$(window).on("keydown.gallery",function(e){var a=e.keyCode;Se&&a!=Spaces.KEYS.ESC||(e.preventDefault(),a==Spaces.KEYS.ESC?s.exit():a==Spaces.KEYS.UP?s.toggleZoom(!0):a==Spaces.KEYS.DOWN?s.toggleZoom(!1):a==Spaces.KEYS.LEFT?s.move(-1):a==Spaces.KEYS.RIGHT&&s.move(1))}).on("resize.gallery orientationchange.gallery",function(e){s.onResize()}),me[e].length<2&&U.addClass("one_image"),page_loader.on("requestend","removegallery",function(e){(!e||_&&location.hash!=_)&&s.exit(!0)},!0),page_loader.on("mailrequestend","removegallery",function(){s.exit(!0)},!0),j&&(location.hash="#GalleryTop"+l)}s.selectItem(e,a,r,!1,0,t),"video"==X.item.content&&U.find("#gallery__zoom, .js-gallery_fullscreen").remove(),s.blinkArrows()}},exit:function(e,a){var t,i=this;X&&(Device.android_app&&tick(function(){i.pullToRefresh(!0)}),U.draggable(!1),i.freeItem(),$("#main").off(".gallery"),$(window).off(".gallery"),a||($("body").removeClass("gallery__transp_open gallery__open"),$("html, body").removeClass("gallery__doc"),document.body.style.cssText="",U.remove(),U=m=null),page_loader.on("requestend","removegallery",!1),page_loader.on("mailrequestend","removegallery",!1),j&&(document.body.style.height="auto"),a||(le||((t=function(){$("html, body").scrollTop(we)})(),tick(t)),i._onGroupTrigger(X.gid,"exit",[])),X=null,Loader.loaded("collections")&&FileCollections.freeInstance("gallery"),!e&&page_loader.ok()&&history.back(),Device.android_app&&($("#pmb8876").remove(),$("#navi").append('<div id="pmb8876">')))},pullToRefresh:function(e){SpacesApp.exec("pullToRefresh",{enable:e}),SpacesApp.exec("fullscreen",{enable:!e,onlyHeader:!0}),SpacesApp.exec("sidebar",{enable:e})},initMouseScale:function(){var r,l,o,n,e,a,t,s=this;if(oe){for(t in n=function(){o=null;var e=Y(H,X.scale,X.imageX,X.imageY,r.w,r.h,!0);s.toggleSiblings(!1),s.setMoveAnim("transform","ease",K,function(){X.scale<=1&&s.toggleZoom(!1,!0)}),s.moveImage(e.x,e.y,e.scale)},a={onmousewheel:"mousewheel",onwheel:"wheel",DOMMouseScroll:"DOMMouseScroll"})if(t in document){e=a[t];break}U[0].addEventListener(e,function(e){var a,t,i;if(!Se&&(e.preventDefault(),e.stopPropagation(),(a=-e.deltaY||e.detail||e.wheelDelta)!==undefined&&s.canScale())){if(o)clearTimeout(o);else{if(t=X.currImage,!(r={h:t.width(),w:t.height()}).w||!r.h||!X)return;l=X.scale,s.setMoveAnim(!1),s.toggleZoom(!0,!0)}o=setTimeout(n,200),i=Y(H,l*=0<a?1.05:.95,X.imageX,X.imageY,r.w,r.h,!1),s.moveImage(i.x,i.y,i.scale)}},!1)}},initGestures:function(){var m,u,p,y,h,v,w,x,b,k,I,M,S,C,e,f,L,D,E,A,z=this,G=!0,T=0,j=1,R=2,F=T;type="none",k=!1,C=new Spaces.Inertia,e=function(){var e=Y(H,X.scale,X.imageX,X.imageY,M,S,!1);z.toggleSiblings(!1),z.setMoveAnim("transform","ease",K,function(){X.scale<=1&&z.toggleZoom(!1,!0)}),z.moveImage(e.x,e.y,e.scale)},U.draggable({disableContextMenu:!1,onlyEvents:!0,realtime:!0,scroll:le,detectZoom:!0,fastEvents:!0,forceStart:!0,calcRelative:!1,events:{zoomStart:function(){F!=R&&F!=T||(G||z.toggleZoom(!0,!0),G=!0)},zoomEnd:function(){!G||F!=R&&F!=T||e(),G=!1},dragStart:function(){F=T,Ie||!X||Se||(Ce=!(G=!1),z.setMoveAnim(!1),v=z.canMove(1),w=z.canMove(-1),m=X.imageY=X.imageY||0,u=X.imageX=X.imageX||0,p=X.scale,C.start(),f=L=0,D=E=0)},dragMove:function(e){var a,t,i,r,l,o,n,s,g,c,d,_;Ce&&X&&!Se&&(D=e.dX-f,E=e.dY-L,h=m,y=u,Me&&(F==T&&(a=Math.abs(D),t=Math.abs(E),i=!G&&1==X.scale,A=z.canScale(),(5<a||5<t||!i)&&(f=e.dX,L=e.dY,D=e.dX-f,E=e.dY-L,5<t&&a<=5&&i?(b=$("#gallery_notif, #gallery_bottom, #gallery_tools, #gallery_zoom, #gallery_descr_wrap"+(le?", .gallery__shadow":"")),F=j,oe&&((x={wrap:$("#gallery_close_msg").show(),closeMsg:$("#gallery_close_text").css("opacity","1"),closedMsg:$("#gallery_closed_text").css("opacity","0"),msg:null}).msg=x.closeMsg,b.cssAnim("opacity","ease-out",J).css("opacity",0),X.currImageWrap.css("overflow","visible"),k=!1,z.switchShadow(!0))):(F=R,r=z.getImageSize(),M=r[0],S=r[1])),z.toggleSiblings(F==R&&1==X.scale&&!G)),F==R?(l=X.scale,e.scale&&A&&(l=p*e.scale),1!=X.scale&&(h+=E),y+=!w&&0<=D||!v&&D<0?D/te:D,oe&&(o=Y(H,l,y,h,M,S,!1),z.moveImage(o.x,o.y,o.scale))):F==j&&(n=h+E/re,h+=E/ie,oe&&(k!=ee<=(s=Math.abs(h))&&(k=ee<s,x.msg[0].style.opacity=0,x.msg=k?x.closedMsg:x.closeMsg),g=x.msg[0].style,c=X.currImageWrap[0].style,d=Math.max(0,Math.min(s/(H.h/2),1)),c.opacity=(1-.4*d).toFixed(2),g=x.msg[0].style,_=Math.max(0,Math.min(s/ee,1)).toFixed(2),E<0?(g.top="-1em",n+=H.rh):g.top="0",g.opacity=_,x.wrap.transform({translate:[y,n]}),z.moveImage(y,h)),I=0<=E),C.add(y,h)))},dragEnd:function(e){var a,t,i,r,l,o,n,s,g,c,d,_,m,u,p,f;if(Ce&&X&&!Se){if(Ce=!1,C.end(),F!=T){if(P(),a=C.speed(),t=C.inertia(4.7),F==R)return i=H.w/2,t&&(1==X.scale?(y+=t.x,(r=.6*H.w)<y&&(y=r),y<-r&&(y=-r),z.moveImage(y,h)):(X.imageX+=t.x,X.imageY+=t.y)),l=Y(H,X.scale,X.imageX,X.imageY,M,S,!0),o=1==X.scale&&a.speedX<-q,n=1==X.scale&&a.speedX>q,s=1==X.scale||l.overX,void((y<-i||o)&&v&&s?z.move(1,!0,!0,!0):(i<y||n)&&w&&s?z.move(-1,!0,!0,!0):(z.setMoveAnim("transform, opacity","ease-out",B),z.moveImage(l.x,l.y,l.scale)));if(F==j&&(h=y=0,g=a.speedY,c=Math.abs(ve)<Q&&q<Math.abs(g)&&0<=g==I,oe)){if(x.wrap.hide(),k||c)return z.lockTouch(!0),z.setMoveAnim("transform, opacity","ease-out",J,function(){z.lockTouch(!1),z.exit()}),z.moveImage(0,I?H.h:-H.h),void X.currImageWrap.css("opacity",0);b.cssAnim().css("opacity",""),X.currImageWrap.css({opacity:"",overflow:""}),z.setMoveAnim("transform, opacity","ease-out",K,function(){z.toggleSiblings(!1)}),z.moveImage(y,h),z.switchShadow(!1)}}else if(!ke){if(X.item.gif&&Math.abs(D)<=10&&Math.abs(D)<=10&&(d=$("#Gallery").offset(),_=Math.max(V,H.w*ae)*X.scale,m=H.h*ae*X.scale,u=d.left+(H.x+H.w)/2-_/2+X.imageX,p=d.top+(H.y+H.h)/2-m/2+X.imageY,e.x>=u&&e.x<=u+_&&e.y>=p&&e.y<=p+m))return(!X.gif_time||500<Date.now()-X.gif_time)&&(X.currImage=Z(X.currImage,X.gifed?X.item.image:X.item.gif),z.moveImage(X.imageX,X.imageY,1),X.gifed=!X.gifed,X.gif_time=Date.now()),void P();f=!0,$(".js-gallery_arrow, .gallery__error_inner, #gallery_tools, #gallery_bottom, #gallery_notif").each(function(){if(W($(this),e.x,e.y))return f=!1}),le&&!W(U,e.x,e.y)&&(tick(function(){z.exit()}),f=!1),f&&"video"!=X.item.content&&(N||(N=setTimeout(function(){N=null,ke||Ce||(1==be?U&&("desktop"==Device.type?U.find(".js-gallery_fullscreen").click():O||z.toggleFullscreen()):2==be&&z.toggleZoom()),be=0},300)),++be)}X.inited||tick(function(){z.postSelectItem()})}}}})},toggleSiblings:function(e){!X.siblings!=!e&&(X.siblings=!!e)},setMoveAnim:function(e,a,t,i){if(oe&&Me&&X.currImageWrap)if(X.siblings)X.currImageWrap.cssAnim(!1),m.cssAnim(e,a,t,i);else if(m.cssAnim(e,a,t),X.fixZoom){var r=function(){var e=i;i=null,e&&e()};X.fixZoom.img.cssAnim(e,a,t,r),X.currImageWrap.cssAnim(e,a,t,r)}else X.currImageWrap.cssAnim(e,a,t,i)},moveImage:function(e,a,t){var i,r,l=this;if(oe&&Me){if(!1===e)return X.scale=1,X.imageY=X.imageX=0,X.currImageWrap.cssAnim(!1),void m.cssAnim(!1).transform({translate:[0,0]});if(e=Math.round(e),a=Math.round(a),i=X.scale,!(t&&t!==X.scale||X.imageY!=a||X.imageX!=e||X._fz!=!!X.fixZoom||X.invalidate))return X.currImageWrap.cssAnim(!1),void l.setMoveAnim(!1);delete X.invalidate,t&&(X.scale!=t&&(X.scale=t,l.recalcFrames(!1),l.toggleZoom(1!=X.scale,!0)),X.zoomDir!=1<=t&&(X.zoomDir=1<=t,U.toggleClass("gallery__zoom",X.zoomDir))),X.imageY=a,X.imageX=e,X._fz=!!X.fixZoom,(r=X.fixZoom)&&r.img.transform({translate:[r.x,r.y+a],scale:r.scale*X.scale}),X.siblings&&1==i?m.transform({translate:[e,0]}):(m.transform({translate:[e,0]}),X.currImageWrap.transform({translate:[0,a],scale:X.scale}))}},fixSiblings:function(){var e,a,t=this;t.syncErrors(),oe&&Me&&X?(e=me[X.gid],(a=t.getNeighbors(X.gid,X.id,!0))&&t.recalcFrames(undefined,e[a.next].image,e[a.prev].image)):"video"!=X.item.content&&X&&(X.currImage=Z(X.currImage,X.item.image))},getFrame:function(e){return oe?u(ve+1+((e=e||0)<0?2:0<e?-2:0),3):e<0?0:1<e?2:1},syncErrors:function(){var e,a=this,t=me[X.gid],i=a.getNeighbors(X.gid,X.id,!0),r=oe?[a.getFrame(-1),a.getFrame(0),a.getFrame(1)]:[a.getFrame()],l=t[i.prev],o=X.item,n=t[i.next],s=[!!l.adult,!!o.adult,!!n.adult],g=[!l.partial&&!!se[l.image],!o.partial&&!!se[o.image],!n.partial&&!!se[n.image]],c=[!!l.not_found,!!o.not_found,!!n.not_found],d=[!(!l.partial||!fe[X.gid]),!(!o.partial||!fe[X.gid]),!(!n.partial||!fe[X.gid])];for(e=0;e<3;++e)$e[r[e]]!=(c[e]||d[e]||s[e]||g[e])&&(c[e]?a.setImageError(r[e],Le.loadError({message:L("Пользователь удалил файл."),action:!1})):d[e]?a.setImageError(r[e],Le.loadError({message:fe[X.gid].errors.join("<br />"),action:"loader"})):g[e]?a.setImageError(r[e],Le.loadError({message:L("Ошибка загрузки изображения. Проверьте ваш интернет."),action:"img"})):a.setImageAdult(r[e],s[e]))},recalcFrames:function(e,a,t){var i,r,l,o,n,s,g,c,d,_,m;if(oe&&Me&&X&&H&&"video"!=X.item.content){for(i=this,l=u(r=ve+1,3),o=u(r-2,3),n=u(r+2,3),!1!==e&&i.moveImage(0,0),g=[-(s=1.05*H.w)-s/2*(X.scale-1),0,s+s/2*(X.scale-1)],c=[n,l,o],+(+X.scale).toFixed(2),d=0;d<3;++d)(e||c[d]!=l)&&$("#gallery_img_"+c[d]+"_wrap").transform({translate:[Math.floor(g[d]),0]});e?(_=$("#gallery_img_"+n),m=$("#gallery_img_"+o),e<0?Z(_,a):Z(m,t),X.currImage=$("#gallery_img_"+l),X.currImageWrap=$("#gallery_img_"+l+"_wrap")):(a||t)&&(D(X.currImage,X.item.image),D($("#gallery_img_"+o),a),D($("#gallery_img_"+n),t))}},update:function(e){var a,t,i,r,l,o=this;X&&(a=pe[X.gid],i=!(t=he[X.gid]||0),r=a.length+t>=ye[X.gid]||!ye[X.gid],i&&r?X.prev=X.next=1<a.length:(X.prev=0<X.n||!i,X.next=X.n+1<a.length||!r),l="video"==X.item.content,$(".js-gallery_arrow[data-dir=-1]").toggleClass("hide",!X.prev||l),$(".js-gallery_arrow[data-dir=1]").toggleClass("hide",!X.next||l),U.find(".js-gallery_cnt").text(L("{0} из {1}",t+X.n+1,Math.max(a.length,ye[X.gid]||0))),e&&(o.fixSiblings(),o.syncErrors()))},selectItem:function(e,a,t,i,r,l){var o,n,s,g,c,d,_,m,u,p,f,y,h,v,w,x,b,k,I,M,S,C=this;if(X&&e==X.gid&&a==X.id)C.update();else{if(C.freeItem(),C.toggleZoom(!1,!0),o=C.getNeighbors(e,a,!0),n=me[e],g="video"==(s=me[e][a]).content,c=pe[e].length,d=o.prev,_=o.next,m=X,X={gid:e,id:a,item:s,zoomed:!1,scale:1,siblings:!0,n:o.n},m&&!m.partial!=!s.partial)for(u=0;u<3;++u)C.setImageError(u,!1);if(C.update(),p=X.prev&&(Me&&X.prev||a!=d)&&n[d],f=X.next&&(Me&&X.next||d!=_)&&n[_],y=p?p.image:A,h=f?f.image:A,!g&&oe&&Me?j?(X.currImage=$("#gallery_img_1"),X.currImageWrap=$("#gallery_img_1_wrap"),X.currImage=Z(X.currImage,s.image),C.syncErrors()):t?tick(function(){var e,a,t;for(H||(H=E()),a=[-(e=1.05*H.w),0,e],t=0;t<3;++t)$("#gallery_img_"+t+"_wrap").transform({translate:[a[t],0]}).removeClass("gallery-anim_hide");X.currImage=$("#gallery_img_1"),X.currImageWrap=$("#gallery_img_1_wrap"),C.moveImage(!1),D($("#gallery_img_0"),y),D($("#gallery_img_2"),h),D(X.currImage,s.image),C.syncErrors()}):C.recalcFrames(r,y,h):(X.currImage=$("#gallery_img_1"),X.currImageWrap=$("#gallery_img_1_wrap"),$("#gallery_img_0").prop("src",y),g||(X.currImage=Z(X.currImage,s.image)),$("#gallery_img_2").prop("src",h),C.syncErrors()),g&&!X.item.partial&&(v=$("#galleryVideo").show(),w=$(X.item.el).find(".player_container:first").attr("id","GVP_"+Date.now()),x=w[0].id,X.playerId=x,v.fastHtml(Le.playerStub({preview:X.item.image})),w.data("preview",X.item.image),b=function(){if(X&&X.playerId==x&&!X.playerInited){v.on("vp_ready vp_resize",function(){C.onResize()});var e=vplayer(w);e.show(v[0].id).onReady(function(){"desktop"==Device.type&&(X.item.adult?X.showOnAdult=function(){e.player.play()}:e.player.play())}),X.playerInited=!0,C.onResize()}},Loader.loaded("video_player")?b():require("video_player",b)),X.item.partial&&(X.item.not_found=!!$(X.item.el).data("notFound"),X.item.type&&!X.item.not_found)){for(k=[],I=[],u=0,S=(M=C.getPartial(X.gid)).length;u<S;++u)s=M[u],k.push(s.nid),I.push(s.type);C._onGroupTrigger(X.gid,"partial",[{partials:M,nids:k,types:I}])}C._onGroupTrigger(X.gid,"list",[{current:X.n,last:!!m&&m.n,total:c}]),i||C.postSelectItem(t,l),C.syncErrors()}},setImageAdult:function(e,a){this.setImageError(e,!!a&&Le.adult({content:X.item.content}))},setImageError:function(e,a){var t=$("#"+("gallery_img_"+e)).parent(),i=t.find(".gallery__error");a?(t.addClass("gallery__show_error"),i.html(a)):$e[e]&&(t.removeClass("gallery__show_error"),i.empty()),$e[e]=!!a,a&&e==this.getFrame(0)&&X.zoomed&&this.toggleZoom(!1)},hasError:function(){return!(!$e[this.getFrame(0)]&&!X.hasError)},postSelectItem:function(e,a){var t,i,r,l;X&&(t=this,i=X.item,e||t.moveImage(!1),X.inited=!0,t.toggleSiblings(!1),ne&&$("#gallery__zoom").toggle("video"!=X.item.content),$("#g_sharelink").prop("href",i.share).toggleClass("mr_l_0",0<i.shareCnt).parents("td").toggleClass("disabled",!i.share).toggleClass("js-clicked",!!+i.reposted),$("#g_advancepage").prop("href",i.commentsLink).toggleClass("mr_l_0",0<i.commentsCnt).parents("td").toggleClass("disabled",!i.commentsLink||0<i.commentsLink.indexOf("#no_link")),(r=$("#gallery_descr")).length&&(r[0].innerHTML=i.description,$("#gallery_descr_wrap").toggleClass("hide",!i.description||"video"==i.content&&"desktop"!=Device.type)),$("#g_dloadlink").prop("href",i.download).toggle(!!i.download),$("#g_shareCnt")[0].innerHTML=+i.shareCnt||"",$("#g_commentCnt")[0].innerHTML=+i.commentsCnt||"",$("#gallery_bottom td").toggle(!X.item.partial),X.item.showMotivator&&!h&&i.share&&tick(function(){GALLERY.showNotif(Le.collectionsMotivator(),{timeout:!1})}),t.syncLikes(),page_loader.ok()&&(l=t.getItemPos(),page_loader.setJSC("gallery",X.gid+"/"+l,!e||a),_=location.hash),t.toggleSiblings(!1),t.onResize(!0),t.toggleSiblings(!0),t.autoHideNotif())},blinkArrows:function(){if("desktop"!=Device.type&&"operamini"!=Device.browser){var e=this,a=$(".gallery__side-arrow");e.arrows_timeout&&clearTimeout(e.arrows_timeout),a.stop(!0,!0).show(),e.arrows_timeout=setTimeout(function(){e.arrows_timeout=!1,a.fadeOut()},1500)}},syncLikes:function(){var l,o,e,a,t,i,n,s=X.item;s.partial||(o=!1,s.parent?(a=(e=s.parent.split(":"))[0]+"_"+e[1],t=$("#"+a+"_voteUp"),i=$("#"+a+"_voteDown"),l=[t.data("clicked")?1:i.data("clicked")?-1:0,t.data("cnt")||0,i.data("cnt")||0,!t.length||t.data("disabled")||0,!i.length],o=a):l=s.like.split(","),n=Spaces.params.nid&&!+l[3]&&s.type!=Spaces.TYPES.EXTERNAL_VIDEO,U.find(".js-vote_btn").each(function(){var e=$(this),a=e.find(".js-vote_btn_cnt"),t=s.type+"_"+s.nid,i=e.data("type"),r=i<0?+l[2]:+l[1];a.toggleClass("mr_l_0",!r).text(r||""),e.attr({id:t+(i<0?"_voteDown":"_voteUp"),title:(i<0?L("Против"):L("За"))+" "+r}).data({cnt:r,oid:s.nid,ot:s.type,disabled:!n,vote_id:t,clicked:l[0]==i,privatePhoto:!!l[4],binded:o}),a.attr("id","vote_"+(i<0?"down":"up")+"_cnt_"+t),e.parents("td").toggleClass("js-clicked",l[0]==i).toggleClass("disabled",!(n&&(-1!=i||!l[4])))}))},freeItem:function(){X&&X.playerInited&&VideoPlayer.destroy(X.playerId)},getItemPos:function(){return X.n+(he[X.gid]||0)},getMaxZoom:function(){var e,a,t,i,r=g(X.item.image);return r&&X.item.size?(a=n((e=o(X.item.size[0],X.item.size[1],r[0],r[1]))[0],e[1],H.w,H.h),t=Math.max(X.item.size[0],X.item.size[1])/Math.max(a[0],a[1]),i=Math.max(X.item.size[0],X.item.size[1])/Math.max(e[0],e[1]),z=Math.max(2,t),[t,i]):1},getImageSize:function(){var e,a,t=g(X.item.image);return t&&X.item.size?[(a=n((e=o(X.item.size[0],X.item.size[1],t[0],t[1]))[0],e[1],H.w,H.h))[0],a[1]]:[X.currImage.width(),X.currImage.height()]},toggleZoom:function(e,a){var r,l,t,i,o,n=this;X&&"video"!=X.item.content&&ne&&(e===undefined&&(e=!X.zoomed),e!=X.zoomed&&(e&&!n.canScale()||(n.autoHideNotif(),X.zoomDir=!0,X.zoomed=e,U.toggleClass("gallery__zoom gallery__nav_hide",X.zoomed),r="session_id:"+Date.now(),l=n.getMaxZoom(),t=Math.max(1.4,l[0]),X.zoomId=r,i=function(){e||(U.removeClass("gallery__loading"),X.fixZoom&&(X.currImage.removeClass("hide"),X.fixZoom.img.remove(),X.fixZoom=!1))},o=function(){if(e&&1.1<=l[1]){U.addClass("gallery__loading");var i=function(e,a){if(X&&X.zoomId==r&&X.zoomed&&!X.fixZoom){if(U.removeClass("gallery__loading"),X.scale<=1)return void setTimeout(function(){i(e,a)},1e3);var t=$("<img>",{id:"gallery_img_z",src:e});X.currImage.addClass("hide").parent().after(t),X.fixZoom={img:t,scale:1/l[0]},n.onResize(!0)}delete ce[e]};s(X.item.download,i)}},a?(i(),o(),n.toggleSiblings(!e)):"ucbrowser"==Device.browser?(i(),o(),n.toggleSiblings(!1),n.setMoveAnim(!1),n.moveImage(0,0,e?t:1),n.toggleSiblings(!e)):(n.toggleSiblings(!1),i(),n.setMoveAnim("transform","ease-out",G,function(){e||n.toggleSiblings(!0),o()}),n.moveImage(0,0,e?t:1)))))},lockTouch:function(e){Ie=e},toggleFullscreen:function(e){b="boolean"==typeof e?e:!b,U.toggleClass("gallery_hide-toolbars",b),H=undefined,this.onResize(!0),b||this.blinkArrows()},isFullscreen:function(){return b},blinkButtons:function(){var e,a=0;"operamini"!=Device.browser?e=setInterval(function(){0==a?U.addClass("gallery__side-arrow_show"):1==a&&(clearInterval(e),U.removeClass("gallery__side-arrow_show"),U.addClass("gallery__animation-ended")),++a},1e3):U.addClass("gallery__animation-ended")},canScale:function(){return X&&(X.gifed?ce[X.item.gif]:ce[X.item.image])&&!this.hasError()},canMove:function(e){return!(e<0&&!X.prev)&&(!(0<e&&!X.next)&&1<pe[X.gid].length)},needLoad:function(e){var a,t,i=this;return!!i.canMove(e)&&(a=he[X.gid]||0,t=ye[X.gid],!!(e<0&&a&&X.n<1)||!!(0<e&&t&&X.n>=pe[X.gid].length-1&&a+X.n<t-1))},getNeighbors:function(e,a,t){var i,r,l=pe[e];for(i=0,r=l.length;i<r;++i)if(l[i]==a)return{prev:0<i?l[i-1]:!!t&&l[l.length-1],next:i+1<l.length?l[i+1]:!!t&&l[0],n:i};return!1},move:function(a,e,t,i){var r,l,o,n;if(X&&(r=this,l=pe[X.gid],r.setMoveAnim(!1),!(Ie||"video"==X.item.content&&Loader.loaded("video_player")&&VideoPlayer.isBusy()))){if(r.needLoad(a)){if(r._onGroupTrigger(X.gid,"load",[{dir:a}]),r.needLoad(a))return void GALLERY.setLoading(!0);if(!e)return void tick(function(){r.move(a,!1)})}if((!((a=0<=a?1:-1)<0)||X.prev)&&(!(0<a)||X.next)){if(Me&&oe){if(e)return o=function(){r.toggleSiblings(!0),r.setMoveAnim("transform","ease-out",B,function(){r.move(a,!1,Ce)});var e=1.05*H.w;r.moveImage((e+e/2*(X.scale-1))*-a,0)},void(v?tick(o):o())}else e=t=!1;(n=X.n+a)>=l.length&&(n=0),n<0&&(n=l.length-1),n=pe[X.gid][n],ve+=a,r.selectItem(X.gid,n,!1,t,a)}}},switchShadow:function(e){if(le){var a="0px 0px 0px "+Math.ceil(Math.max(($(window).innerWidth()-H.w)/2,$(window).innerHeight()-H.rh/2))+"px "+i;U.css(R,a+(e?", inset "+a:""))}},onResize:function(e){var a,t,i,r,l,o,n,s,g,c,d,_,m,u,p,f,y,h,v,w=this;X&&(H&&e||(a=$(window).innerHeight(),t=Math.max(window.innerHeight,a),document.body.style.cssText=a!=t?"min-height:"+t+"px !important":"",H=E()),w.switchShadow(!1),X.hasError&&(i=$("#Gallery_error .gallery-error_msg")).css("top",(H.rh-i.height())/2),"video"==X.item.content?(r=$("#Gallery .js-vc_status"),l=H.h+(r.length?-r.outerHeight(!0):0),Loader.loaded("video_player")&&(o=vplayer(X.playerId,!0))&&o.setMaxSize(H.w,l),(f=H.w)<(v=(h=l)*(y=16/9))&&(h=(v=f)/y),n=[Math.round(v),Math.round(h)],$("#galleryVideoStub").css({maxWidth:n[0]+"px",maxHeight:n[1]+"px"}),$("#galleryVideo").css("margin-top",(l-n[1])/2+"px")):e||w.recalcFrames(),F&&(s=x(),(g=X.currImage).attr("style","max-height: "+(x()-8)+"px !important;max-width: "+(U.width()-2)+"px"),g.show(),j&&((c=$("#gallery_bottom")).removeClass("gallery__bottom").addClass("gallery_tools"),c[0].style.top=s+k+"px"),F&&$("#Gallery__wrapper").css({height:s+"px",marginTop:b?0:k+"px",marginBottom:b?0:I+"px"})),e||tick(function(){X&&w.moveImage(X.imageX,X.imageY)}),(d=X.fixZoom)&&(m=(_=w.getMaxZoom()[0])/(1/d.scale),u=X.scale*m,d.scale=1/_,d.x=Math.round((H.w-X.item.size[0])/2),d.y=Math.round((H.rh-X.item.size[1])/2),p=Y(H,u,X.imageX,X.imageY,!0),X.invalidate=!0,w.moveImage(p.x,p.y,p.scale)))},addPhoto:function(e,a){var t,i,r,l,o,n,s,g,c,d,_,m,u=this;for(a||(pe={}),t=!1,i=e||$(".gview_link"),r=0;r<i.length;++r)if(n=(o=p(l=i[r])).gid,!_e[n]){if(me[n]||(me[n]=[]),pe[n]||(pe[n]=[]),!l.gallery_cache_id){if(s=me[n].length,"video"==o.content&&j)continue;if(l.onclick=u._openLink,j&&!l.href&&(l.href="#"+Date.now()),l.gallery_cache_id=++xe,ue[l.gallery_cache_id]=o,a){for(c=0,d=(g=me[n]).length;c<d;++c)if((_=g[c]).partial&&_.nid==o.nid&&_.type==o.type){s=_.n;break}me[n][s]=o}else me[n].push(o);o.n=s,o.el.setAttribute("data-gallery_id",s)}a||(X&&X.item.n==o.n&&(X.n=pe[n].length,t=!0),pe[n].push(o.n))}!X||a||t||(n=X.gid,m=u.getItemPos(),pe[n][m]||(m=pe[n].length-1),u.exit(!0,!0),u.open(n,m,!0,!0))},updatePartial:function(e,a){var t,i=this;i.addPhoto(a,!0),X&&(e=X.gid,t=X.id,i.exit(!0,!0),i.open(e,t,!0,!0))},_openLink:function(e){if((e=e||window.event).stopPropagation&&e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),$.draggableNoClick())return!1;var a=p($(this)[0]);return De.open(a.gid,a.n),!1},removeFiles:function(e,a,t,i){var r,l,o,n=pe[e],s=me[e],g=[];if(a<0){for(r=0;r<t;++r)o=s[l=n[r]].el,ue[o.gallery_cache_id]=null,g.push(o),me[l]=null;X&&(X.n-=t),pe[e]=n.splice(t)}else{for(r=n.length-t;r<n.length;++r)o=s[l=n[r]].el,ue[o.gallery_cache_id]=null,g.push(o),me[l]=null;pe[e]=n.splice(0,n.length-t)}i?$(g).parents(i).remove():$(g).remove()},getFiles:function(e,a,t,i){var r,l,o,n=pe[e],s=[];if(n)for(r=a,l=Math.min(n.length,a+t);r<l;++r)o=me[e][n[r]],s.push(i?$(o.el).parents(i)[0]:o.el);return s},getPartial:function(e){var a,t,i,r=pe[e],l=[];if(r)for(a=0,t=r.length;a<t;++a)(i=me[e][r[a]]).partial&&i.type&&l.push(i);return l},onGroup:function(e,a,t){return this.on(a+":"+e,t)},unlockGroup:function(e){_e[e]=null,delete _e[e]},_onGroupTrigger:function(e,a,t){return this._trigger(a+":"+e,t)},setBaseOffset:function(e,a){he[e]=a},setGroupVisibleCount:function(e,a){ye[e]=a},getGroupCnt:function(e,a){if(!pe[e])return 0;var t=pe[e].length;return a&&ye[e]||t},showNotif:function(e,a){var t=this;a=$.extend({timeout:5e3},a),f&&clearTimeout(f),$("#gallery_notif").remove(),U.append(Le.notif({text:e})),a.timeout&&(f=setTimeout(function(){t.hideNotif()},a.timeout)),y=!0},hideNotif:function(){var e=$("#gallery_notif");clearTimeout(f),f=0,y=!1,oe?e.cssAnim("opacity","ease-out",300,function(){e.remove()}).css("opacity",0):e.remove()},autoHideNotif:function(){y&&this.hideNotif()},setLoading:function(e){X&&!X.isLoading!=!e&&($("#Gallery").toggleClass("gallery__loading gallery__lock",!!e),X.isLoading=Ie=!!e)},setGroupError:function(e,a,t){a?fe[e]?($.inArray(a,fe[e].errors)<0&&fe[e].errors.push(a),fe[e].callbacks.push(t)):fe[e]={errors:[a],callbacks:[t]}:delete fe[e],X&&this.syncErrors()},setError:function(e,a){var t,i,r=this;X&&X.hasError!=e&&(r.setLoading(!1),t=$("#Gallery_error").toggle(!!e).html(e?Le.error(e+(a?"<br />":"")):""),a&&(i=$(Le.retry()).click(function(e){e.preventDefault(),a()}),t.find(".gallery-error_msg").append(i)),X.hasError=Ie=!!e,r.onResize(!0),X.hasError&&X.zoomed&&r.toggleZoom(!1))},getGalleryRect:E,lock:function(e){Se=e}}));window.GALLERY=De,t=Class({Static:{setupLoaders:function(e){return $(e||".js-gallery_loader").each(function(){var e=$(this);e.data("GalleryLoader")||e.data("GalleryLoader",new t(e))}).data("GalleryLoader")}},Constructor:function(e){var a=this;a.opts=$.extend({apiMethod:"",apiData:{},total:0,limit:0,offset:0,gc:!1,itemWrap:!1,hasMore:!1,fixResult:null},e.data()),a.el=e,a.offset=0,a.loaded_offset=a.opts.offset,a.total=a.opts.total,a.limit=a.opts.limit,a.setupGallery()&&a.hasMore(0)&&(a.update(),page_loader.push("shutdown",function(){a.destroy()}))},hasMore:function(e){var a=this;return 0<e?a.loaded_offset+a.offset+a.limit<a.total:e<0?!!a.loaded_offset:a.hasMore(-1)||a.hasMore(1)},gc:function(){var e,a=this,t=De.getGroupCnt(a.gid),i=((a.page-1)*a.limit-a.loaded_offset)/a.limit,r=(t-(a.page*a.limit-a.loaded_offset))/a.limit;S<i&&(e=i-M,De.removeFiles(a.gid,-1,e*a.limit,a.opts.itemWrap),a.offset-=e*a.limit,a.loaded_offset+=e*a.limit,De.setBaseOffset(a.gid,a.loaded_offset)),S<r&&(e=r-M,De.removeFiles(a.gid,1,e*a.limit,a.opts.itemWrap),a.offset-=e*a.limit)},setupGallery:function(){var s=this,e=s.el.find(".gview_link");return!!e.length&&(s.limit||(s.limit=2*e.length),s.gid=p(e[0]).gid,De.unlockGroup(s.gid),De.setBaseOffset(s.gid,s.loaded_offset),De.addPhoto(),De.onGroup(s.gid,"partial",function(n){var a=function(){s.loadData(function(e){var a,t,i,r,l,o;for(s._load_partial=!1,a=De.getFiles(s.gid,0,Math.min(e.widgets.length,n.types.length)),t=[],i=0;i<a.length;++i)l=(r=$(a[i])).index(),o=r.parent(),e.widgets[i]?(r.replaceWith(e.widgets[i]),t.push(o.children()[l])):r.attr("data-not-found",1);GALLERY.updatePartial(s.gid,t)},function(e){s._load_partial=!1,GALLERY.setError(e.message||L("Ошибка загрузки. "),a)},0,n.types.length,{nids:n.nids,types:n.types})};s._load_partial||(s._load_partial=!0,a())}),De.onGroup(s.gid,"load",function(e){s._go_next=!0,De.setLoading(!0)}),De.onGroup(s.gid,"exit",function(e){s.el.trigger("galleryExit",{page:s.page,total:s.total})}),De.onGroup(s.gid,"list",function(e){var a,t,i,r;!1!==e.last?a=e.current-e.last:0==e.current?a=-1:e.current==e.total-1&&(a=1),t=100*(1-Math.min(1,a<0?e.current/s.limit:(e.total-e.current)/s.limit)),w<t&&s.load(a),i=s.getPage(s.loaded_offset+e.current+1),s.page!=i&&(r=De.getFiles(s.gid,(i-1)*s.limit-s.loaded_offset,s.limit,s.opts.itemWrap),s.el.trigger("galleryPageChanged",{files:r,prevFiles:s.shadow_prev_items,nextFiles:s.shadow_next_items,page:i,lastPage:s.page,totalPages:Math.ceil(De.getGroupCnt(s.gid,!0)/s.limit)}),s.page=i)}),s.shadow_prev_items=$('<div class="hide">').insertBefore(s.el),s.shadow_next_items=$('<div class="hide">').insertAfter(s.el),s.page=s.getPage(s.loaded_offset+s.offset+1),!0)},getPage:function(e){return Math.max(1,Math.ceil(e/this.limit))},update:function(){De.setGroupVisibleCount(this.gid,this.total)},load:function(a){var t=this;a=a<0?-1:1,t.hasMore(a)&&t.loadChunk(t.limit*a,function(){t._go_next&&(De.move(a),t._go_next=!1)},function(e){De.setError(e.message,function(){De.setError(!1),De.setLoading(!0),t.load(a)})})},loadChunk:function(i,r,a){var e,l=this;l._proccess||(e=i<0?l.loaded_offset+i:l.loaded_offset+l.offset+i,l._proccess=!0,l.loadData(function(e){l._proccess=!1,l.total=e.count,De.setLoading(!1);var a=e.widgets,t=De.getGroupCnt(l.gid);(t+a.length>=l.total||a.length<i)&&(l.total=t+a.length+l.loaded_offset),0<i?l.shadow_next_items.append(a.join("")):l.shadow_prev_items.prepend(a.join("")),l.offset+=a.length,i<0&&(l.loaded_offset-=a.length),l.update(),De.setBaseOffset(l.gid,l.loaded_offset),De.addPhoto(),l.opts.gc&&l.gc(),De.update(!0),r()},function(e){l._proccess=!1,a(e)},e,Math.abs(i)))},loadData:function(a,t,i,r,e){var l=this,o=$.extend({},l.opts.apiData,{L:r,O:i});e&&(o.IdS=e.nids,o.TyPes=e.types),Spaces.api(l.opts.apiMethod,o,function(e){l.opts.fixResult&&l.opts.fixResult(e),e.code==Codes.AUTH.ERR_AUTH_ERROR&&e.auth_errror==Codes.AUTH.AUTH_ERROR.ERR_FREQ_LIMIT?(console.error(":("),setTimeout(function(){l.loadData(i,r,a,t)},3e3)):0!=e.code?t({message:Spaces.services.processingCodes(e),retry:!0}):a(e)},{onError:function(e){t({message:e,retry:!0})}})},destroy:function(){this.el=null,this.shadow_prev_items.remove(),this.shadow_next_items.remove()}}),window.GalleryLoader=t,define("gallery","onRequest",function(){Loader.ready(function(){"operamini"!=Device.browser&&t.setupLoaders(),De.init(),De.addPhoto()})})});