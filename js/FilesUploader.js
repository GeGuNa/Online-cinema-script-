define("lib_filesuploader","init",function(){var _="_progress",h="/progress",a=1500,o=7e3,e=0<=navigator.userAgent.indexOf("UCBrowser")||"ucbrowser"==Device.browser,x=!1,v=function(e){this.events={},this.ajax=v.isAjaxSupport()};$.extend(v,{isAjaxApiSupport:function(){return!e&&navigator.userAgent.indexOf("IEMobile")<0&&"undefined"!=typeof File&&"undefined"!=typeof(new XMLHttpRequest).upload&&(!Device.webkit()||534.13<=Device.webkit())},isAjaxSupport:function(){return v.isAjaxApiSupport()||v.inAppUpload()},needNtiveControls:function(){return!v.inAppUpload()&&("ucbrowser"==Device.browser||"msie"==Device.browser&&Device.v<9||Device.webkit()&&Device.webkit()<534.13||v.needStaticUpload())},inAppUpload:function(){return Device.android_app&&0<=navigator.userAgent.toLowerCase().indexOf("android 4.4")},maybeUnsupported:function(){return 0<navigator.userAgent.indexOf("Windows Phone 8.0")&&!e},needStaticUpload:function(){return 0<navigator.userAgent.indexOf("Windows Phone")&&e}}),$.extend(v.prototype,{setup:function(e){var t=this;return t.destroy(),t.params=$.extend(!0,{autoSubmit:!1,buttonClass:{hover:"",focus:"",active:""},extra:null,dragPlace:null,postData:{},action:{},name:"file",multiple:!1,ngxProgress:!0,maxFiles:1,responseType:"json",allowedExtensions:[],notAllowedExtensions:[]},e),t._init(),t},resetDragPlaces:function(){var e,t=this;if(t._dragndrop_places)for(e=0;e<t._dragndrop_places.length;++e)$(t._dragndrop_places[e]).off(".SpFilesUploader");return t},resetPastePlaces:function(){var e,t=this;if(t._paste_btns)for(e=0;e<t._paste_btns.length;++e)$(t._paste_btns[e]).off(".SpFilesUploader");return t},destroy:function(){var e=this;$([window,document.body]).off(".SpFilesUploader"),e.resetDragPlaces().resetPastePlaces(),e.input_wrap&&e.input_wrap.remove(),e.input&&$(e.input).remove(),e.files=[],e._in_upload=!1,e._paste_btns=[],e._dragndrop_places=[],e.cur_file_id=null,e.input=e.input_wrap=null},set:function(e){var t=this;return $.extend(t.params,e),t._createInput(),t},setButton:function(e,t){var n=this;return n.clearButton(),n.params.buttonClass=$.extend({hover:"",focus:"",active:""},t),n.button=(e instanceof jQuery?e:$(e)).first(),n.button.on("mouseover.SpFilesUploader touchmove.SpFilesUploader",function(){n.updateButton()}),n.button.css({position:"relative"}).append(n.input_wrap),"inline"==n.button.css("display")&&n.button.css("display","inline-block"),n._createInput(),n},clearButton:function(){return self.button&&(self.button.off(".SpFilesUploader"),self.button=null),self},_init:function(){var i=this;i.input_wrap=$("<div>").css({display:"block",position:"absolute",overflow:"hidden",margin:0,padding:0,opacity:0,cursor:"pointer",visibility:"visible",direction:"ltr",zIndex:2147483583,filter:"alpha(opacity=0)"}).prop("ajax_upload_button",!0),i.input_wrap.on("mousedown touchstart",function(){i.button&&(i.button.addClass(i.params.buttonClass.active),$(window).one("mouseup",function(){i.button.removeClass(i.params.buttonClass.active)}))}),i.input_wrap.on("touchend touchcancel",function(){i.button&&i.button.removeClass(i.params.buttonClass.active)}),i.input_wrap.on("mouseover",function(){i.button&&i.button.addClass(i.params.buttonClass.hover)}),i.input_wrap.on("mouseout",function(){i.button&&(i.button.removeClass(i.params.buttonClass.hover),i.button.removeClass(i.params.buttonClass.focus))}),i.input_wrap.on("focus",function(){i.button&&i.button.addClass(i.params.buttonClass.focus)}),i.input_wrap.on("blur",function(){i.button&&i.button.removeClass(i.params.buttonClass.focus)}),i.on("uploadStart",function(){1!=i.params.maxFiles&&i.params.autoSubmit?i.updateButton():i.input_wrap.hide()}),i.on("complete",function(){1!=i.params.maxFiles&&i.params.autoSubmit||i.input_wrap.show(),i.updateButton()}),v.inAppUpload()&&SpacesApp.on("file",function(e,t,n){i.input&&e&&(i._createInput(),i.addFiles([{filename:e,name:e,size:t}]))}).on("preview",function(e,t){var n,r;for(n=0;n<i.files.length;++n)if((r=i.files[n]).file.filename==e){i._trigger("preview",[r,"data:image/jpeg;base64,"+t]);break}})},_createInput:function(){var e,t,n=this;delete n.input,e=ce("input",{type:"file",name:n.params.name}),t=0<Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor"),1<n.params.maxFiles&&v.isAjaxSupport()&&!t&&(e.multiple=!0),e.ajax_upload_button=!0,n.params.accept&&(e.accept=n.params.accept),e.onclick=function(){return 1<n.params.maxFiles&&n.getTotalFiles()>=n.params.maxFiles||!n._trigger("checkLimit")?(n._trigger("limitError"),!1):v.inAppUpload()?(SpacesApp.exec("selectFile",{multiple:e.multiple}),!1):void 0},e.onchange=function(){(""!=this.value||this.files.length)&&(n._createInput(),this.onchange=null,n.ajax?n.addFiles(this.files):n.addFiles([this]))},n.input=e,n.button&&(n.input_wrap.empty(),n.input_wrap.append(e),n.updateButton(),extend(e.style,{position:"absolute",right:0,margin:0,padding:0,fontFamily:"sans-serif",cursor:"pointer"}),e.style.cssText+=";font-size: 480px !important;"),setTimeout(function(){n._trigger("input",[e])},0)},updateButton:function(){var e,t,n=this;n.button&&(e=n.button.outerWidth()+"px",t=n.button.outerHeight()+"px",extend(n.input.style,{width:e,height:t,fontSize:"360px"}),n.input_wrap.css({width:e,height:t}).css({left:0,top:0}))},progressAvail:function(){return this.ajax},inUpload:function(){return this._in_upload},getInput:function(){return this.input},getFiles:function(){return this.files},getExt:function(e){var t=e.match(/\.([~\w\d_-]{1,16})$/i);return t&&t[1]||""},setPostData:function(e){return this.params.postData=e,this},addFiles:function(e,t){var n,r,i,a,o,s,u,l,p=this;if(!p._in_upload||1!=p.params.maxFiles){for(n={"image/pjpeg":"jpg","image/jpeg":"jpg","image/jpg":"jpg","image/gif":"gif","image/png":"png","audio/mp3":"mp3"},1==p.params.maxFiles&&(p.files=[]),p._trigger("filesChunkStart"),t=t||"upload_",r=0;r<e.length;++r){if(i=e[r],p.params.maxFiles<=p.getTotalFiles()){p._trigger("limitError");break}if(p.ajax&&!v.inAppUpload()&&!(i instanceof File&&i.name)){if(!(a=n[i.type]))continue;i.name=i.filemame=p._genFileName(t)+"."+a}if(o=$.trim(p._getFilename(p.ajax?i.name:i.value)),s=p.getExt(o),u=p.ajax?i.size:undefined,l={id:Date.now()+"_"+r,file:i,name:o,ext:s,size:u,postData:p.params.postData,action:p.params.action,formName:p.params.name},p.params.maxSize&&u!==undefined&&null!==u&&p.params.maxSize<u)p._trigger("sizeError",[l]);else{if(o){if(p.params.allowedExtensions.length&&!p._checkExt(s,p.params.allowedExtensions)){p._trigger("extError",[l]);continue}if(p.params.notAllowedExtensions.length&&p._checkExt(s,p.params.notAllowedExtensions)){p._trigger("extError",[l]);continue}}l.extra=p.params.extra,p._trigger("file",[l])&&(p.files.push(l),p.needMakePreview(l)&&(v.inAppUpload()?SpacesApp.exec("getPreview",{file:l.file.filename}):p.ajax&&function(t){tick(function(){var e=p.createObjectURL(t.file);e&&p._trigger("preview",[t,e])})}(l)))}}p._trigger("filesChunkEnd"),p.params.autoSubmit&&p.files.length&&(p.submit(),p._trigger("afterAutoSubmit"))}},needMakePreview:function(e){return e.size<=10485760&&/^(gif|jpg|jpeg|png|bmp|webp)$/i.test(e.ext)},createObjectURL:function(e){var t=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL;return t&&t.createObjectURL?t.createObjectURL(e):null},submit:function(){var e=this,t=function(){!(0<e.files.length)||e._current_file&&e._current_file.abort?(e._current_file=null,e._in_upload=!1,e._trigger("complete"),e.files=[]):(e._in_upload=!0,e._current_file=e.files[0],e._submit(function(){e._current_file==e.files[0]&&e.files.shift(),t()}))};return e._in_upload||(!e.ajax&&0<!e.files.length&&(e.addFiles([e.input]),e._createInput()),0<e.files.length?(e._trigger("uploadStart"),t()):e._trigger("notSelectedError")),this},reset:function(){return this._in_upload||(this._trigger("reset"),this.files=[]),this},_submit:function(n){var e,t,r,i,a,o,s,u,l,p,c,f,d=this,g=d._current_file;if(d._trigger("submit",[g]))if(e=new Url(g.action),t=d._getUID(),d.params.ngxProgress&&!v.inAppUpload()&&(e.query["X-Progress-ID"]=t,e.path=e.path.replace(/\/+$/,"")+_+"/",r=e.scheme+"://"+e.domain+(e.port?":"+e.port:"")+h,d.simulateProgress(t,r,function(e,t){d._trigger("progress",[g,e/t*100,e,t])}),d._trigger("progress",[g,0,0,0])),v.inAppUpload())g._request=!0,SpacesApp.on("uploadProgress",function(e,t){d._trigger("progress",[g,e/t*100,e,t])}).on("uploadSuccess",function(e){d._onDone(g,e),setTimeout(n,0)}).on("uploadError",function(e){d._trigger("error",[g,e,Spaces.getHttpError(e),""]),setTimeout(n,0)}),SpacesApp.exec("upload",{action:e.url(),name:g.formName.replace("%d",g.id),file:g.file.filename,params:g.postData||{}});else if(d.ajax){for(a in i=new FormData,post=g.postData,post)if(post[a]instanceof Array)for(o=0;o<post[a].length;++o)i.append(a,post[a][o]);else i.append(a,post[a]);i.append(g.formName.replace("%d",g.id),g.file,g.name),(s=d._xhr()).onreadystatechange=function(){try{if(4==s.readyState){if(d.simulateProgress(!1),!s.__is_abort){g._request=null,s.onreadystatechange=function(){};var e=0;try{e=s.status}catch(t){}try{s.statusText}catch(t){}200<=e&&e<300?d._onDone(g,s.responseText):d._trigger("error",[g,e,Spaces.getHttpError(e),s.responseText])}setTimeout(n,0)}}catch(t){d._trigger("error",[g,-1,t.stack||t.message]),setTimeout(n,0),d.simulateProgress(!1)}},s.open("POST",e.url(),!0);try{s.withCredentials=!0}catch(m){}"onprogress"in s&&(s.upload.onloadstart=function(e){d._trigger("progress",[g,0])},s.upload.onprogress=function(e){if(e.lengthComputable){var t=e.loaded/e.total*100;d._trigger("progress",[g,t,e.loaded,e.total])}x||(x=!0,d.simulateProgress(!1))}),s.setRequestHeader("X-Requested-With","XMLHttpRequest"),s.send(i),g._request=s}else l=!1,-1<navigator.userAgent.indexOf("MSIE 7")?u=document.createElement('<iframe src="javascript:false;" name="'+t+'">'):((u=document.createElement("iframe")).src="javascript:false;",u.name=t),u.style.display="none",u.id=t,document.body.appendChild(u),p=function(){delete g._request,$(u).remove(),u=null,$(window).off("."+t),d.simulateProgress(!1)},u.onload=function(e){if(!1===e)return setTimeout(n,0),void d.simulateProgress(!1);g._request&&(delete g._request,setTimeout(function(){l||(d._trigger("error",[g,-1,L("Сервер ответил неожиданным ответом. (iframe)")]),setTimeout(n,0),p())},800))},c=e.url(),(f=d._getForm(t,c,g.postData)).appendChild(g.file),document.body.appendChild(f),$(window).on("message."+t,function(e){delete g._request;var t=e.originalEvent;try{if(0!=c.indexOf(t.origin))return void console.log("[uploader] non matched origin: ",c,e.originalEvent.origin);l=!0,d._onDone(g,t.data)}catch(e){d._trigger("error",[g,-1,e.stack||e.message,t.data])}setTimeout(n,0),p()}),g._request=u,f.submit(),$(f).remove(),f=null;else setTimeout(n,0)},getFileIndex:function(e){var t,n=this;for(t=0;t<n.files.length;++t)if(n.files[t].id==e)return t;return-1},isInUpload:function(){return this._in_upload},total:function(){return this.files.length},setFileParams:function(e,t){var n,r,i,a,o=this,s=o.getFileIndex(e);if(-1<s)for(i in n=["action","name","postData"],r=o.files[s],n)t[a=n[i]]!==undefined&&(r[a]=t[a]);return o},remove:function(e){return this.removeByIndex(this.getFileIndex(e))},removeByIndex:function(e){var t=this;return-1<e&&(t.cancel(e),t._trigger("remove",[t.files[e]]),t.files.splice(e,1)),t},getTotalFiles:function(){var e={total:this.files.length};return 1==this.params.maxFiles?0:(this._trigger("getTotal",[e]),e.total)},cancel:function(e){var t,n,r=this;if("number"==typeof e){if((t=r.files[e])&&t._request){if(v.inAppUpload())SpacesApp.exec("cancelUpload");else if(r.ajax)t._request.__is_abort=!0,t._request.abort();else{(n=t._request).onload(!1),n.onload=null;try{n.stop()}catch(i){}try{n.execCommand("stop")}catch(i){}try{n.contentWindow.document.execCommand("stop")}catch(i){}n.src="javascript:false;"}delete t._request,r._trigger("cancel",[t]),r.simulateProgress(!1)}}else if(r._current_file)for(r._current_file.abort=!0;r.files.length;)r.removeByIndex(0);return r},_getForm:function(e,t,n){var r,i,a,o=document.createElement("form");for(r in o.action=t,o.method="POST",o.target=e,o.name=this._getUID(),o.style.display="none",o.encoding="multipart/form-data",o.enctype="multipart/form-data",n)if((i=document.createElement("input")).type="hidden",n[r]instanceof Array)for(a=0;a<n[r].length;++a)i.name=r,i.value=n[r][a],o.appendChild(i);else i.name=r,i.value=n[r],o.appendChild(i);return o},_onDone:function(e,t){try{"json"==this.params.responseType&&"string"==typeof t&&(t=$.parseJSON(t))}catch(n){t=null}t?this._trigger("uploaded",[e,t]):this._trigger("error",[e,-1,L("Сервер ответил неожиданным результатом.")])},simulateProgress:function(e,t,n){var r,i=this;e&&x||(e?(i.progress_interval&&i.simulateProgress(!1),i.progress_interval=setInterval(function(){Date.now()-r<=o||(r=Date.now(),$.ajax({url:t,jsonp:"callback",dataType:"jsonp",data:{"X-Progress-ID":e}}).success(function(e){"starting"!=e.state&&"uploading"!=e.state?i.simulateProgress(!1):"uploading"==e.state&&n(e.received,e.size)}).always(function(){r=0}))},a)):(i.progress_interval&&clearInterval(i.progress_interval),i.progress_interval=null))},on:function(e,t){return this.events[e]||(this.events[e]=[]),this.events[e].push(t),this},_trigger:function(e,t){var n,r,i=!0;if(this.events[e])for(n=0;n<this.events[e].length;++n)if((r=this.events[e][n])&&!1===r.apply(this,t||[])){i=!1;break}return i},_xhr:function(){var e;if("undefined"!=typeof XMLHttpRequest)e=new window.XMLHttpRequest;else if(window.ActiveXObject)try{e=new window.ActiveXObject("Microsoft.XMLHTTP")}catch(t){return!1}return e},_checkExt:function(e,t){for(var n=0;n<t.length;++n)if(t[n].toLowerCase()===e.toLowerCase())return!0;return!1},_getUID:function(){return"axxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},_genFileName:function(e){var t=new Date;return(e||"upload_")+t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)+"_"+("0"+t.getHours()).slice(-2)+"."+("0"+t.getMinutes()).slice(-2)+"."+("0"+t.getSeconds()).slice(-2)},_getFilename:function(e){return e.replace(/\\/g,"/").replace(/^.+\//g,"").replace(/^C__Data_Users_DefApps_AppData_INTERNETEXPLORER_([^_]+)_/,"")}}),window.FilesUploader=v});