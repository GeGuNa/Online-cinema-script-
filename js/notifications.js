define("notif","init",function(){var a,c=24e4,s="operamobile"==Device.browser&&Device.v<=12,e="operamini"==Device.browser,r=!e&&Spaces.params.nid,n=Device.css("position","fixed",/fixed/i),d={},u=function(e){var t={1:"system-message_service",2:"",3:"system-message_alert"};return e.text=e.text.replace(/(spcs\.me|spaces\.ru)/gi,base_domain()),'<div id="notif_'+e.id+'" class="oh system-message notification_item '+(e.n||e.delayed?"hide ":"")+(e.delayed?"js-notif_to_show ":"")+t[e.severity]+'"><span class="notif_text"><span class="ico ico_remove js-notif_close pointer right"></span></span><span class="notification_counter '+(e.n?"":"hide ")+'">'+(e.n+1)+"</span> "+Spaces.prepareLink(e.text)+"</div>"},l=Class({Constructor:function(){var e,t,i,n,o=this;"operamobile"==Device.browser&&Device.v;o.lock=!1,o.deffered=[],o.blinker={interval:null,old_title:null},o.ncounter=0,o.top_notif_queue=[],o.top_notif_queue_lock=!1,o.page_load_time=(new Date).getTime(),o.oncounterchange=null,e="hidden",t="",i=document,e in document?t="visibilitychange":(e="mozHidden")in document?t="mozvisibilitychange":(e="webkitHidden")in document?t="webkitvisibilitychange":(e="msHidden")in document?t="msvisibilitychange":"onfocusin"in document?t="focusin focusout":(t="pageshow pagehide focus blur",i=window),o.window_active="true"!=cookie.get("spacesactive"),document[e]!==undefined&&o.checkWindow(!document[e]),$(i).on(t,{hidden:e},class_func(o,o.checkWindow)),cookie.set("spacesactive","true",{expires:7}),require("ajaxify",function(){page_loader.ok()&&(page_loader.onRequestStart("notifications",function(){o.lock=!0}),page_loader.onRequestEnd("notifications",function(){$("#top_notif_place").find(".js-notif_close").click(),$(".lp_notif_message").click(),o.lock=!1,$.each(o.deffered,function(e,t){o.pushNotification(t)}),o.deffered=[]}),page_loader.on("shutdown","notifications",function(){o.setPlace(!1)},!0))}),$(function(){var e="spaces:tab"+o.page_load_time+":alive",i=function(){Spaces.LocalStorage.get(e)&&Spaces.LocalStorage.remove(e)};$.each([document,window,document.body],function(e,t){t.addEventListener&&t.addEventListener("storage",i,!1)})}),r&&(Spaces.params.play_sound&&require("sound",function(){(a=new SpacesSound).ready(function(){a.load(ICONS_BASEURL+"sounds/newMessage.mp3")})}),pushstream.addMessageHandler("notifications",class_func(o,o.onLongPolling)),o.beacon_interval=setInterval(function(){Spaces.api("neoapi/common.beacon",d)},c)),n="touchmove.activity_detect touchstart.activity_detect keydown.activity_detect click.activity_detect MozMousePixelScroll.activity_detect mousewheel.activity_detect wheel.activity_detect scroll.activity_detect mousemove.activity_detect",$(window).on(n,function(e){e.originalEvent&&(o.window_active=!0,$(window).off(".activity_detect"))})},Static:{COUNTER:{JOURNAL:1,LENTA:2,MAIL:3},counters:{1:{title:L("Журнал"),id:"jour_notif_cnt",key:"journal"},2:{title:L("Лента"),id:"lent_notif_cnt",key:"lenta"},3:{title:L("Почта"),id:"mail_notif_cnt",key:"mail"}},_instance:null,instance:function(){return l._instance||(l._instance=new l),l._instance}},onLongPolling:function(e){var t,i=this;e.act==Spaces.LongPollingTypes.KARMA_CHANGED&&$(".js-karma_value").text((+e.value).toFixed(2)),i.needIgnore(e)||(e.act==Spaces.LongPollingTypes.NOTIFICATION_SEND?0<=$.inArray(Spaces.params.sid,e.sessions_ctimes)&&(e.lp=!0,i.pushNotification(e)&&i.showNewEvent(L("Новое событие"))):e.act==Spaces.LongPollingTypes.TOP_COUNTER_UPDATE?i.updateCounter(e.type,e.cnt,{important:!!e.important}):e.act==Spaces.LongPollingTypes.COMM_COUNTER_UPDATE&&(t=$("#cc"+e.com_id)).length&&(t.find(".acnt").text(e.cnt),0<e.cnt?t.show():t.hide()))},autohideTopNotif:function(e){var t=this,i=$(window);return e||$(".lp_notif_wrapper").length?i.on("scroll.autohideTopNotif",function(){var e=i.scrollTop();e<=50?t.closeTopNotif():n||$(".lp_notif_wrapper").css({top:e+"px"})}):i.off(".autohideTopNotif"),this},checkWindow:function(e){var t=this,i=null,n={focus:!0,focusin:!0,pageshow:!0,blur:!1,focusout:!1,pagehide:!1};if("boolean"==typeof e)i=e;else if(n[e.type]!==undefined)i=n[e.type];else{if(document[e.data.hidden]===undefined)throw"Unknown event: "+e.type;i=!document[e.data.hidden]}t.window_active!==i&&((t.window_active=i)?t.onFocusWindow():t.onBlurWindow())},isAliveTab:function(e,t){var i=Date.now(),n="spaces:tab"+e+":alive";Spaces.LocalStorage.set(n,i),setTimeout(function(){Spaces.LocalStorage.get(n)?(Spaces.LocalStorage.remove(n),t(!1)):t(!0)},100)},getTabId:function(){return this.page_load_time},onBlurWindow:function(){cookie.set("spacesactive","false",{expires:7}),$(".lp_notif_wrapper").remove(),$("#main").trigger("blurwindow")},onFocusWindow:function(){this.titleBlink(!1),cookie.set("spacesactive","true",{expires:7}),this.showBackgroundNotifications(),$("#main").trigger("focuswindow")},getCounter:function(e){return parseInt($("#"+l.counters[e].id).text())},setNotifFilter:function(e){return this.re_filter=e,this},setPlace:function(e,t,i){!1!==e?(d.objectType=i,d.Type=e,d.Id=t):(delete d.objectType,delete d.Type,delete d.Id)},needIgnore:function(e){return e.Oid&&d.Id&&e.Oid==d.Id&&e.Ot==d.objectType},updateCounter:function(e,t,i){var n,o,a,c,s=this;return i=extend({blink:!0,important:!1},i||{}),(n=l.counters[e])?(a=(a=(o=$("#"+n.id)).text()).length<1?0:+a)==t?s:((c=jQuery.Event("counterchange")).counterType=e,c.counterValue=t,$("#main").trigger(c),c.isDefaultPrevented()?this:(c.counterValue!=t&&(t=c.counterValue),0<t?o.text(t):o.stop(!0,!0).fadeOut(function(){o.text("")}),0<t&&(s.showNewEvent(n.title+" +"+t),i.blink&&$(window).scrollTop()<10?0<o.not(":animated").length&&o.fadeTo(500,.2).fadeTo(499,1).fadeTo(500,.2).fadeTo(499,1).fadeTo(500,.2).fadeTo(499,1):o.fadeTo(0,1)),s)):(console.error("Unknown counter type: ",e),s)},showNewEvent:function(e,t){var i=this,n=cookie.get("spacesactive");return t=$.extend({oneTab:!1,notif:!0},t),cookie.set("pageLoadTime",i.page_load_time,{expires:7}),"true"==n?i.window_active?t.opts&&i.pushTopNotification({text:e}):t.oneTab&&i._bgNotif(e,t.oneTab):i._bgNotif(e,t.oneTab),this},_bgNotif:function(e,t){var i=this;setTimeout(function(){i.titleBlink(e),i.playSoundInBg(t)},300)},showNotification:function(e,t,i){i=extend({silent:!0},i||{}),t=t||"info";return this.renderNotification({id:"user_"+(new Date).getTime(),generic:!0,text:e,severity:{error:3,warning:2,info:1}[t]}),i.silent||this.showNewEvent(L("Новое событие")),this},pushNotifications:function(e){for(var t=0;t<e.length;++t)this.pushNotification(e[t]);return this},pushNotification:function(e){var t=this;if(e.lp){if((parseInt(cookie.get("qnotid"))||0)>=e.id)return console.error("Старая нотификация",e,new Date),!1;if(this.window_active&&cookie.set("qnotid",e.id,{expires:7}),this.lock)return e.lp=!1,t.deffered.push(e),!1}return t.re_filter&&t.re_filter.test(e.text)||this.renderNotification(e),!0},closeNotification:function(e){var t,i=this,n=$("#notif_"+e);return n.length&&(n.remove(),--this.ncounter),(t=$("#top_notif_place .notification_item").first())&&(t.find(".notification_counter").text(this.ncounter).toggle(1!=this.ncounter),t.show()),i.fixLocationBar(),this},renderNotification:function(t){var i=this,e=$("#top_notif_place"),n=$(u({id:t.id,n:i.ncounter,delayed:t.lp&&!i.window_active,severity:t.severity,text:t.text})),o=n.find(".js-comments_notif").each(function(){var e=$(this);e.data("id")==d.Id&&e.data("type")==d.Type&&e.remove()}).length;return o&&!$.trim(n.find(".notif_text").text()).length?this:(0<this.ncounter&&e.find(".notification_item").first().find(".notification_counter").text(this.ncounter+1).removeClass("hide"),n.prop("nid",t.id).prop("generic",!t.lp),n.find(".js-notif_close").on("click",function(e){e.preventDefault(),t.close_link&&Spaces.api(t.close_link,{}),i.closeNotification(t.id)}),++i.ncounter,e.append(n),i.fixLocationBar(),i)},fixLocationBar:function(){var e=0<$("#top_notif_place .notification_item:visible").length;$("#header_path").toggleClass("no-shadow",e)},showBackgroundNotifications:function(e){var t,i=$("#top_notif_place"),n=parseInt(cookie.get("qnotid")||0),o=i.find(".js-notif_to_show");for(t=0;t<o.length;++t)o[t].nid<=n?this.closeNotification(o[t].nid):((n=parseInt(cookie.get("qnotid")||0))<o[t].nid&&cookie.set("qnotid",o[t].nid,{expires:7}),$(o[t]).removeClass("js-notif_to_show"));return this},pushTopNotification:function(e){return $(window).scrollTop()<=50?this:(e.id=e.id||(new Date).getTime(),this.top_notif_queue.push(e),this.topNotifQueue())},topNotifQueue:function(e){var i,t,n,o=this;if(e||!o.top_notif_queue_lock){if(o.top_notif_queue.length)return o.top_notif_queue_lock||(o.autohideTopNotif(!0),o.top_notif_queue_lock=!0),i=o.top_notif_queue.shift(),function(){$(this).remove(),o.topNotifQueue(!0)},t=function(){var t=o.renderTopNotif(i);t.slideDown({duration:400,start:function(){t.css("margin-left",-t.width()/2+"px")},done:function(){if(0<o.top_notif_queue.length)t.delay(2e3).slideUp(400,function(){$(this).remove(),o.topNotifQueue(!0)});else{var e=t.find(".lp_notif_message");s?setTimeout(function(){e.addClass("lp_notif_message-fade")},5e3):e.delay(5e3).fadeTo(400,.5),o.topNotifQueue(!0)}}})},0<(n=$(".lp_notif_wrapper")).length?n.first().slideUp(400,function(){$(this).remove(),t()}):t(),o;o.top_notif_queue_lock=!1}},renderTopNotif:function(e){var t=this,i=$('<div id="top_notif_id_'+e.id+'" class="lp_notif_wrapper hide'+(n?" lp_notif_wrapper_fixed":"")+'"><div class="lp_notif_message">'+e.text+"</div></div>");return n||i.css({top:$(window).scrollTop()}),i.find(".lp_notif_message").on("click",{id:e.id},function(e){e.preventDefault(),$("html, body").scrollTop(0),t.closeTopNotif()}),$(document.body).append(i),i},closeTopNotif:function(){return this.top_notif_queue=[],$(".lp_notif_wrapper").remove(),this.autohideTopNotif(!1),this},playSound:function(){if(r)return require("sound",function(){a.ready(function(){a.isSingle()&&Loader.loaded("music")&&MusicPlayer.playing()||(a.setVolume(100),a.stop(),tick(function(){a.play()}))})}),this},playSoundInBg:function(e){var t=parseInt(cookie.get("pageLoadTime")||0);return(this.page_load_time==t||e)&&Spaces.params.play_sound&&this.playSound(),this},titleBlink:function(e){var t,i=this,n=!0;return i.blinker.interval&&(document.title=i.blinker.old_title,clearInterval(i.blinker.interval),i.blinker.interval=null),e&&((t=function(){n?(i.blinker.old_title=document.title,document.title=e,n=!1):(document.title=i.blinker.old_title,n=!0),"true"==cookie.get("spacesactive")&&i.titleBlink(!1)})(),i.blinker.interval=setInterval(t,1e3)),this},isWindowActive:function(){return this.window_active}});e||(window.Notifications=l,Spaces.notifications=new l)});